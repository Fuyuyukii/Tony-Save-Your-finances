// Schema Prisma para Sistema Unificado de Envelopes
// Tony Save Your Finances

// Envelope - Modelo unificado para Metas e Fundos
model Envelope {
  id                    String   @id @default(uuid())
  nome                  String
  descricao             String?
  icone                 String   // emoji ou nome do ícone
  cor                   String   // hex color
  tipo                  EnvelopeType  // FUNDO ou META

  // Valores e progresso
  meta_valor            Decimal  @db.Decimal(10, 2)
  saldo_atual           Decimal  @default(0) @db.Decimal(10, 2)
  prazo                 DateTime?
  observacoes           String?

  // Depósito automático recorrente
  deposito_automatico   Boolean  @default(false)
  deposito_valor        Decimal? @db.Decimal(10, 2)  // valor fixo OU
  deposito_percentual   Decimal? @db.Decimal(5, 2)   // percentual do incoming
  deposito_frequencia   FrequenciaDeposito?
  deposito_dia          Int?     // dia do mês (1-31) ou dia da semana (0-6)

  // Campos específicos para tipo META
  produto_nome          String?
  produto_url           String?
  produto_imagem_url    String?
  produto_preco_atual   Decimal? @db.Decimal(10, 2)
  produto_preco_inicial Decimal? @db.Decimal(10, 2)
  alertas_preco         Boolean  @default(false)

  // Status
  status                EnvelopeStatus @default(ATIVO)
  data_completado       DateTime?
  data_arquivado        DateTime?

  // Relacionamentos
  conta_id              String
  conta                 Account  @relation(fields: [conta_id], references: [id], onDelete: Cascade)

  usuario_id            String
  usuario               User     @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  // Histórico de movimentações
  transacoes            EnvelopeTransaction[]

  // Timestamps
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  @@index([usuario_id])
  @@index([conta_id])
  @@index([tipo])
  @@index([status])
  @@map("envelopes")
}

// Transações do Envelope (depósitos e retiradas)
model EnvelopeTransaction {
  id                    String   @id @default(uuid())

  tipo                  EnvelopeTransactionType  // DEPOSITO ou RETIRADA
  valor                 Decimal  @db.Decimal(10, 2)
  descricao             String?
  data                  DateTime @default(now())

  // Se foi automático ou manual
  automatico            Boolean  @default(false)

  // Relacionamentos
  envelope_id           String
  envelope              Envelope @relation(fields: [envelope_id], references: [id], onDelete: Cascade)

  // Pode vincular a uma transação real da conta (quando retirar do envelope para usar)
  transacao_id          String?  @unique
  transacao             Transaction? @relation(fields: [transacao_id], references: [id])

  created_at            DateTime @default(now())

  @@index([envelope_id])
  @@index([data])
  @@map("envelope_transactions")
}

// Enums
enum EnvelopeType {
  FUNDO  // Reserva contínua (IPVA, Emergência, etc)
  META   // Objetivo específico (Notebook, Viagem, etc)

  @@map("envelope_type")
}

enum EnvelopeStatus {
  ATIVO      // Em uso normal
  COMPLETO   // Meta atingida (só para tipo META)
  ARQUIVADO  // Finalizado/arquivado pelo usuário
  PAUSADO    // Temporariamente pausado

  @@map("envelope_status")
}

enum EnvelopeTransactionType {
  DEPOSITO
  RETIRADA

  @@map("envelope_transaction_type")
}

enum FrequenciaDeposito {
  DIARIA
  SEMANAL
  QUINZENAL
  MENSAL

  @@map("frequencia_deposito")
}

// Observações sobre o modelo:
//
// 1. FUNDO vs META:
//    - FUNDO: Nunca muda para status COMPLETO, continua acumulando
//    - META: Muda para COMPLETO quando saldo_atual >= meta_valor
//
// 2. Depósito Automático:
//    - Se deposito_valor: usa valor fixo (ex: R$ 200/mês)
//    - Se deposito_percentual: calcula % das receitas (ex: 10% do salário)
//    - deposito_dia: quando executar (dia do mês ou dia da semana)
//
// 3. Produto (só para META):
//    - Campos opcionais para rastreamento de preço
//    - Sistema pode alertar quando preço mudar
//
// 4. Saldo da Conta vs Saldo em Envelopes (IMPORTANTE):
//    - Envelope tem SALDO PRÓPRIO separado da conta
//    - Depositar em envelope: tira dinheiro da conta e coloca no envelope
//    - Retirar do envelope: tira do envelope e devolve para a conta
//    - Envelopes são "potes/cofres separados", NÃO são etiquetas virtuais
//
// 5. Transações do Envelope:
//    - DEPOSITO: aumenta saldo_atual do envelope + diminui saldo da conta
//    - RETIRADA: diminui saldo_atual do envelope + aumenta saldo da conta
//    - Cada operação gera 2 movimentações (uma no envelope, outra na conta)
//
// 6. Fluxo de Depositar:
//    - Usuário deposita R$ 300 no envelope IPVA
//    - Cria Transaction de SAÍDA na Conta (-R$ 300)
//    - Cria EnvelopeTransaction de DEPOSITO (+R$ 300)
//    - Conta: R$ 5.000 → R$ 4.700
//    - Envelope: R$ 800 → R$ 1.100
//
// 7. Fluxo de Retirar:
//    - Usuário retira R$ 200 do envelope Notebook
//    - Cria EnvelopeTransaction de RETIRADA (-R$ 200)
//    - Cria Transaction de ENTRADA na Conta (+R$ 200)
//    - Envelope: R$ 2.500 → R$ 2.300
//    - Conta: R$ 4.700 → R$ 4.900
