<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tony Save - Envelopes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal.hidden .modal-content {
            transform: scale(0.95);
        }
        .icon-option {
            transition: all 0.2s ease;
        }
        .icon-option.selected {
            border-color: #22c55e;
            background-color: #f0fdf4;
            transform: scale(1.1);
        }
        /* Bloquear scroll da p√°gina quando modal est√° aberto */
        body.modal-open {
            overflow: hidden;
        }
        /* Efeito de eleva√ß√£o para cards clic√°veis */
        .card-hover {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        /* Sidebar lateral */
        .sidebar-detalhes {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-detalhes.open {
            transform: translateX(0);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Left side: Logo -->
                <div class="flex items-center">
                    <button id="mobile-menu-btn" class="md:hidden p-2 mr-2 text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <a href="index.html" class="flex items-center">
                        <span class="text-2xl font-bold text-brand-600">Tony</span>
                        <span class="text-2xl font-light text-gray-600 ml-1">Finances</span>
                    </a>
                </div>

                <!-- Nav Links Desktop -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="index.html" class="text-gray-500 hover:text-gray-700 py-5">Dashboard</a>
                    <a href="transacoes.html" class="text-gray-500 hover:text-gray-700 py-5">Transa√ß√µes</a>
                    <a href="contas.html" class="text-gray-500 hover:text-gray-700 py-5">Contas</a>
                    <a href="cartoes.html" class="text-gray-500 hover:text-gray-700 py-5">Cart√µes</a>
                    <a href="envelopes.html" class="text-brand-600 font-medium border-b-2 border-brand-600 py-5">Envelopes</a>
                    <a href="relatorios.html" class="text-gray-500 hover:text-gray-700 py-5">Relat√≥rios</a>
                    <a href="dividas.html" class="text-gray-500 hover:text-gray-700 py-5 relative">
                        D√≠vidas
                        <span class="absolute -top-1 -right-3 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">3</span>
                    </a>
                </div>

                <!-- Right side -->
                <div class="flex items-center space-x-4">
                    <!-- Notifications -->
                    <button id="notifications-btn" class="relative p-2 text-gray-400 hover:text-gray-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                        <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>

                    <!-- User Avatar -->
                    <div class="w-8 h-8 bg-brand-500 rounded-full flex items-center justify-center text-white font-semibold cursor-pointer">
                        V
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden border-t border-gray-200 py-3">
            <div class="flex flex-col space-y-2">
                <a href="index.html" class="px-4 py-2 text-gray-500 hover:bg-gray-50">Dashboard</a>
                <a href="transacoes.html" class="px-4 py-2 text-gray-500 hover:bg-gray-50">Transa√ß√µes</a>
                <a href="contas.html" class="px-4 py-2 text-gray-500 hover:bg-gray-50">Contas</a>
                <a href="cartoes.html" class="px-4 py-2 text-gray-500 hover:bg-gray-50">Cart√µes</a>
                <a href="envelopes.html" class="px-4 py-2 text-brand-600 font-medium bg-brand-50">Envelopes</a>
                <a href="relatorios.html" class="px-4 py-2 text-gray-500 hover:bg-gray-50">Relat√≥rios</a>
                <a href="dividas.html" class="px-4 py-2 text-gray-500 hover:bg-gray-50 flex items-center justify-between">
                    D√≠vidas
                    <span class="bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">3</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600 mb-1">üí≥ Saldo em Contas</div>
                <div class="text-3xl font-bold text-gray-900">R$ 5.300,00</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600 mb-1">üíº Total em Envelopes</div>
                <div class="text-3xl font-bold text-brand-600">R$ 4.300,00</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600 mb-1">üí∞ Patrim√¥nio Total</div>
                <div class="text-3xl font-bold text-gray-900">R$ 9.600,00</div>
            </div>
        </div>

        <!-- Create Envelope Button -->
        <div class="mb-6 flex justify-between items-center">
            <h2 class="text-2xl font-bold text-gray-900">Meus Envelopes</h2>
            <button onclick="openCreateModal()" class="bg-brand-500 hover:bg-brand-600 text-white px-6 py-3 rounded-lg font-medium flex items-center space-x-2 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                <span>Criar Envelope</span>
            </button>
        </div>

        <!-- Fundos -->
        <section class="mb-8">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">üí∞ FUNDOS</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- IPVA -->
                <div data-envelope-id="ipva" class="bg-white rounded-lg shadow-md p-6 card-hover" onclick="openEnvelopeDetails('ipva')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="text-3xl">üöó</div>
                            <div>
                                <h4 class="font-semibold text-gray-900">IPVA 2026</h4>
                                <p class="text-sm text-gray-500">Conta: Nubank</p>
                            </div>
                        </div>
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">FUNDO</span>
                    </div>

                    <div class="mb-3">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">R$ 800 / R$ 1.000</span>
                            <span class="text-brand-600 font-semibold">80%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="bg-yellow-500 h-3 rounded-full" style="width: 80%"></div>
                        </div>
                    </div>

                    <div class="flex space-x-2" onclick="event.stopPropagation()">
                        <button onclick="openDepositModal('ipva')" class="flex-1 bg-brand-50 text-brand-600 py-2 rounded font-medium hover:bg-brand-100 transition">
                            Depositar
                        </button>
                        <button onclick="openWithdrawModal('ipva')" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded font-medium hover:bg-gray-200 transition">
                            Retirar
                        </button>
                    </div>
                </div>

                <!-- Emerg√™ncia -->
                <div data-envelope-id="emergencia" class="bg-white rounded-lg shadow-md p-6 card-hover" onclick="openEnvelopeDetails('emergencia')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="text-3xl">üè•</div>
                            <div>
                                <h4 class="font-semibold text-gray-900">Reserva de Emerg√™ncia</h4>
                                <p class="text-sm text-gray-500">Conta: Nubank</p>
                            </div>
                        </div>
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">FUNDO</span>
                    </div>

                    <div class="mb-3">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">R$ 1.000 / R$ 1.000</span>
                            <span class="text-brand-600 font-semibold">100%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="bg-green-600 h-3 rounded-full" style="width: 100%"></div>
                        </div>
                    </div>

                    <div class="text-xs text-green-600 font-medium mb-4 flex items-center">
                        ‚úÖ Meta atingida! Dep√≥sito autom√°tico pausado.
                    </div>

                    <div class="flex space-x-2" onclick="event.stopPropagation()">
                        <button onclick="openDepositModal('emergencia')" class="flex-1 bg-brand-50 text-brand-600 py-2 rounded font-medium hover:bg-brand-100 transition">
                            Depositar
                        </button>
                        <button onclick="openWithdrawModal('emergencia')" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded font-medium hover:bg-gray-200 transition">
                            Retirar
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Metas -->
        <section>
            <h3 class="text-lg font-semibold text-gray-700 mb-4">üéØ METAS</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- Notebook -->
                <div data-envelope-id="notebook" class="bg-white rounded-lg shadow-md p-6 card-hover" onclick="openEnvelopeDetails('notebook')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="text-3xl">üíª</div>
                            <div>
                                <h4 class="font-semibold text-gray-900">Notebook Gamer Dell G15</h4>
                                <p class="text-sm text-gray-500">Conta: Nubank</p>
                            </div>
                        </div>
                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">META</span>
                    </div>

                    <div class="mb-3">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">R$ 2.500 / R$ 5.000</span>
                            <span class="text-brand-600 font-semibold">50%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="bg-brand-500 h-3 rounded-full" style="width: 50%"></div>
                        </div>
                    </div>

                    <div class="text-xs text-gray-600 mb-3 space-y-1">
                        <div>üìä Faltam: R$ 2.500</div>
                        <div>‚è±Ô∏è Previs√£o: 3 meses</div>
                        <div>üí° Guardar R$ 833/m√™s</div>
                    </div>

                    <div class="flex space-x-2" onclick="event.stopPropagation()">
                        <button onclick="openDepositModal('notebook')" class="flex-1 bg-brand-50 text-brand-600 py-2 rounded font-medium hover:bg-brand-100 transition">
                            Depositar
                        </button>
                        <button onclick="openWithdrawModal('notebook')" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded font-medium hover:bg-gray-200 transition">
                            Retirar
                        </button>
                        <a href="https://amazon.com.br/notebook-dell-g15" target="_blank" class="bg-gray-100 text-gray-700 px-4 py-2 rounded font-medium hover:bg-gray-200 transition flex items-center" title="Ver produto">
                            üîó
                        </a>
                    </div>
                </div>

                <!-- Viagem (sem produto vinculado) -->
                <div data-envelope-id="viagem" class="bg-white rounded-lg shadow-md p-6 card-hover" onclick="openEnvelopeDetails('viagem')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="text-3xl">‚úàÔ∏è</div>
                            <div>
                                <h4 class="font-semibold text-gray-900">Viagem Europa 2026</h4>
                                <p class="text-sm text-gray-500">Conta: Inter (Caixinha)</p>
                            </div>
                        </div>
                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">META</span>
                    </div>

                    <div class="mb-3">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">R$ 3.200 / R$ 15.000</span>
                            <span class="text-brand-600 font-semibold">21%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="bg-brand-500 h-3 rounded-full" style="width: 21%"></div>
                        </div>
                    </div>

                    <div class="text-xs text-gray-600 mb-3 space-y-1">
                        <div>‚è±Ô∏è Previsao: 8 meses</div>
                        <div>üí° Guardar R$ 1.475/mes</div>
                    </div>

                    <div class="flex space-x-2" onclick="event.stopPropagation()">
                        <button onclick="openDepositModal('viagem')" class="flex-1 bg-brand-50 text-brand-600 py-2 rounded font-medium hover:bg-brand-100 transition">
                            Depositar
                        </button>
                        <button onclick="openWithdrawModal('viagem')" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded font-medium hover:bg-gray-200 transition">
                            Retirar
                        </button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Sidebar: Criar Envelope -->
    <div id="createEnvelopeSidebar" class="fixed inset-0 z-50 hidden">
        <!-- Overlay -->
        <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closeCreateEnvelopeSidebar()"></div>

        <!-- Sidebar -->
        <div class="absolute right-0 top-0 h-full w-full md:w-2/3 lg:w-1/2 bg-white shadow-2xl overflow-y-auto transform transition-transform duration-300">
            <!-- Header -->
            <div id="createEnvelopeHeader" class="sticky top-0 bg-white border-b border-gray-200 p-6 z-10">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <button id="createEnvelopeBackBtn" onclick="goBackToTypeSelection()" class="hidden text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h3 id="createEnvelopeTitle" class="text-xl font-bold text-gray-900">üíº Criar Envelope</h3>
                    </div>
                    <button onclick="closeCreateEnvelopeSidebar()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="p-6">
                <!-- Passo 1: Escolher Tipo -->
                <div id="createEnvelopeStep1" class="space-y-6">
                    <p class="text-gray-600">Que tipo de envelope voc√™ quer criar?</p>

                    <div class="space-y-4">
                        <!-- Op√ß√£o FUNDO -->
                        <button onclick="selectEnvelopeType('FUNDO')" class="w-full border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 rounded-lg p-4 text-left transition group">
                            <div class="flex items-start space-x-3">
                                <div class="text-3xl">üí∞</div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900 group-hover:text-blue-600">FUNDO</h4>
                                    <p class="text-sm text-gray-600 mt-1">Reserva cont√≠nua</p>
                                    <p class="text-xs text-gray-500 mt-2">Ex: IPVA, Emerg√™ncia, F√©rias</p>
                                </div>
                            </div>
                        </button>

                        <!-- Op√ß√£o META -->
                        <button onclick="selectEnvelopeType('META')" class="w-full border-2 border-gray-200 hover:border-purple-500 hover:bg-purple-50 rounded-lg p-4 text-left transition group">
                            <div class="flex items-start space-x-3">
                                <div class="text-3xl">üéØ</div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900 group-hover:text-purple-600">META</h4>
                                    <p class="text-sm text-gray-600 mt-1">Objetivo de compra</p>
                                    <p class="text-xs text-gray-500 mt-2">Ex: Notebook, Viagem, Carro</p>
                                </div>
                            </div>
                        </button>
                    </div>

                    <button onclick="closeCreateEnvelopeSidebar()" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition">
                        Cancelar
                    </button>
                </div>

                <!-- Passo 2: Formul√°rio META -->
                <div id="createEnvelopeFormMeta" class="hidden">
                    <form id="createMetaForm" class="space-y-6">
                        <!-- Nome da Meta -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da meta</label>
                            <input type="text" placeholder="Ex: Notebook Gamer Dell G15" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                        </div>

                        <!-- Valor Total -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor total</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3 text-gray-500">R$</span>
                                <input type="number" step="0.01" placeholder="5.000,00" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                            </div>
                        </div>

                        <!-- √çcone -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Escolha um √≠cone</label>
                            <div class="grid grid-cols-6 sm:grid-cols-8 gap-2">
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üíª">üíª</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="‚úàÔ∏è">‚úàÔ∏è</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üöó">üöó</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üè†">üè†</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üì±">üì±</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üéÆ">üéÆ</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üíç">üíç</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üé∏">üé∏</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üì∑">üì∑</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üéØ">üéØ</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üíé">üíé</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üé®">üé®</button>
                            </div>
                        </div>

                        <!-- Produto (opcional) -->
                        <div class="border-t pt-6">
                            <div class="flex items-center justify-between mb-4">
                                <label class="text-sm font-medium text-gray-700">Produto (opcional)</label>
                                <span class="text-xs text-gray-500">Rastrear pre√ßo</span>
                            </div>
                            <div class="space-y-3">
                                <input type="text" placeholder="Nome do produto" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                                <div>
                                    <input type="url" id="urlCompraMeta" placeholder="Link de compra (https://...)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">Cole o link da loja onde pretende comprar o produto</p>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="alertPrecoMeta" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                    <label for="alertPrecoMeta" class="ml-2 text-sm text-gray-700">Alertar quando o pre√ßo mudar</label>
                                </div>
                                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                    <p class="text-xs text-amber-800">
                                        <strong>Em breve:</strong> O sistema vai acompanhar automaticamente o pre√ßo do produto e buscar promo√ß√µes para voc√™!
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Dep√≥sito Autom√°tico -->
                        <div class="border-t pt-6">
                            <div class="flex items-center mb-4">
                                <input type="checkbox" id="depositoAutoMeta" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                <label for="depositoAutoMeta" class="ml-2 text-sm font-medium text-gray-700">Dep√≥sito autom√°tico</label>
                            </div>
                            <div id="depositoAutoFieldsMeta" class="space-y-4 hidden">
                                <!-- Tipo de Dep√≥sito -->
                                <div>
                                    <label class="block text-sm text-gray-700 font-medium mb-3">Quando depositar?</label>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <label class="border-2 border-gray-300 rounded-lg p-3 cursor-pointer hover:border-brand-500 transition">
                                            <input type="radio" name="tipoDepositoMeta" value="frequencia" class="mr-2" checked>
                                            <span class="text-sm font-medium">Por frequ√™ncia</span>
                                            <p class="text-xs text-gray-500 ml-6">Todo dia X, toda semana, etc</p>
                                        </label>
                                        <label class="border-2 border-gray-300 rounded-lg p-3 cursor-pointer hover:border-brand-500 transition">
                                            <input type="radio" name="tipoDepositoMeta" value="receita" class="mr-2">
                                            <span class="text-sm font-medium">Quando receber</span>
                                            <p class="text-xs text-gray-500 ml-6">Ao receber sal√°rio ou receitas</p>
                                        </label>
                                    </div>
                                </div>

                                <!-- Campos Frequ√™ncia -->
                                <div id="camposFrequenciaMeta" class="space-y-4">
                                    <!-- Valor -->
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-2">Valor do dep√≥sito</label>
                                        <div class="relative">
                                            <span class="absolute left-4 top-3 text-gray-500">R$</span>
                                            <input type="number" step="0.01" id="createMetaValorFixo" placeholder="200,00" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-brand-500">
                                        </div>
                                    </div>

                                    <!-- Bloco de Repeti√ß√£o (igual edi√ß√£o) -->
                                    <div class="p-4 bg-gray-50 rounded-xl space-y-4">
                                        <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Repetir</p>

                                        <!-- Frequ√™ncia -->
                                        <div>
                                            <select id="createMetaFrequencia" class="frequencia-select w-full px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent bg-white font-medium" data-prefix="createMeta">
                                                <option value="diaria">Todo dia</option>
                                                <option value="semanal">Toda semana</option>
                                                <option value="quinzenal">A cada 15 dias</option>
                                                <option value="mensal" selected>Todo m√™s</option>
                                                <option value="trimestral">A cada 3 meses</option>
                                                <option value="anual">Todo ano</option>
                                            </select>
                                        </div>

                                        <!-- Op√ß√µes Mensal/Trimestral/Anual -->
                                        <div id="createMeta-opcoes-mensal" class="space-y-3">
                                            <div>
                                                <label class="block text-xs text-gray-500 mb-1.5">Quando</label>
                                                <select id="createMeta-quando-mensal" class="quando-mensal-select w-full px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent bg-white" data-prefix="createMeta">
                                                    <option value="dia" selected>Dia espec√≠fico</option>
                                                    <option value="primeiro">Primeiro dia do m√™s</option>
                                                    <option value="ultimo">√öltimo dia do m√™s</option>
                                                    <option value="primeiro-util">Primeiro dia √∫til</option>
                                                    <option value="ultimo-util">√öltimo dia √∫til</option>
                                                </select>
                                            </div>

                                            <!-- Campo para dia espec√≠fico -->
                                            <div id="createMeta-dia-especifico-container" class="flex items-center gap-3">
                                                <div class="flex-1">
                                                    <label class="block text-xs text-gray-500 mb-1.5">Dia</label>
                                                    <input type="number" id="createMetaDia" min="1" max="28" value="5" class="w-full px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent bg-white font-medium">
                                                </div>
                                                <div class="flex-1">
                                                    <label class="block text-xs text-gray-500 mb-1.5">&nbsp;</label>
                                                    <label class="flex items-center h-[46px] px-4 bg-white border border-gray-300 rounded-xl cursor-pointer hover:bg-gray-50">
                                                        <input type="checkbox" id="createMeta-dia-util-check" class="mr-2 text-brand-600 focus:ring-brand-500 rounded">
                                                        <span class="text-sm text-gray-700">Dia √∫til</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Op√ß√µes Semanal/Quinzenal -->
                                        <div id="createMeta-opcoes-semanal" class="hidden">
                                            <label class="block text-xs text-gray-500 mb-1.5">No dia</label>
                                            <select id="createMeta-dia-semana" class="w-full px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent bg-white">
                                                <option value="domingo">Domingo</option>
                                                <option value="segunda" selected>Segunda-feira</option>
                                                <option value="terca">Ter√ßa-feira</option>
                                                <option value="quarta">Quarta-feira</option>
                                                <option value="quinta">Quinta-feira</option>
                                                <option value="sexta">Sexta-feira</option>
                                                <option value="sabado">S√°bado</option>
                                            </select>
                                        </div>

                                        <!-- Op√ß√µes Di√°ria -->
                                        <div id="createMeta-opcoes-diaria" class="hidden">
                                            <label class="flex items-center p-3 bg-white rounded-xl border border-gray-200 cursor-pointer hover:bg-gray-50">
                                                <input type="checkbox" id="createMeta-apenas-dias-uteis" class="mr-3 text-brand-600 focus:ring-brand-500 rounded">
                                                <div>
                                                    <span class="text-sm font-medium text-gray-700">Apenas dias √∫teis</span>
                                                    <p class="text-xs text-gray-500">Ignora s√°bados, domingos e feriados</p>
                                                </div>
                                            </label>
                                        </div>

                                        <!-- Preview inline -->
                                        <div class="flex items-center justify-between p-3 bg-brand-50 rounded-xl border border-brand-100">
                                            <div class="flex items-center text-sm">
                                                <svg class="w-5 h-5 text-brand-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                                <span class="text-brand-700">Pr√≥ximo dep√≥sito</span>
                                            </div>
                                            <span id="createMetaPreviewInline" class="text-sm font-semibold text-brand-800">05/Fev/2026</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Campos Quando Receber -->
                                <div id="camposReceitaMeta" class="hidden">
                                    <div class="space-y-4">
                                        <div>
                                            <div class="flex items-center justify-between mb-2">
                                                <label class="block text-sm text-gray-600">Quanto depositar?</label>
                                                <!-- Toggle Fixo/Percentual -->
                                                <div class="inline-flex rounded-lg border border-gray-300 p-1 bg-gray-50">
                                                    <button type="button" class="toggle-valor-tipo px-3 py-1 text-xs font-medium rounded transition bg-white shadow-sm text-brand-600" data-tipo="fixo" data-target="metaReceitaSidebar">
                                                        R$ Fixo
                                                    </button>
                                                    <button type="button" class="toggle-valor-tipo px-3 py-1 text-xs font-medium rounded transition text-gray-600" data-tipo="percentual" data-target="metaReceitaSidebar">
                                                        % Percentual
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Campo Valor Fixo -->
                                            <div id="valorFixoMetaReceitaSidebar">
                                                <div class="relative">
                                                    <span class="absolute left-4 top-3 text-gray-500">R$</span>
                                                    <input type="number" step="0.01" placeholder="200,00" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500">
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">Valor fixo a ser depositado</p>
                                            </div>

                                            <!-- Campo Percentual -->
                                            <div id="valorPercentualMetaReceitaSidebar" class="hidden">
                                                <div class="relative">
                                                    <input type="number" step="0.01" placeholder="10" class="w-full pr-10 pl-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500">
                                                    <span class="absolute right-4 top-3 text-gray-500">%</span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">Percentual da receita a ser depositado</p>
                                            </div>
                                        </div>

                                        <div>
                                            <label class="block text-sm text-gray-600 mb-2">Aplicar em</label>
                                            <select id="aplicarEmMetaSidebar" class="aplicar-em-select w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500" data-target="seletorCategoriasMetaSidebar">
                                                <option value="todas">Todas as receitas</option>
                                                <option value="categorias">Categorias espec√≠ficas</option>
                                            </select>

                                            <!-- Seletor de Categorias -->
                                            <div id="seletorCategoriasMetaSidebar" class="hidden mt-3">
                                                <label class="block text-xs text-gray-600 mb-2">Selecione as categorias de receita:</label>
                                                <div class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                        <input type="checkbox" value="salario" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                                        <span class="text-sm">üíº Sal√°rio</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                        <input type="checkbox" value="freelance" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                                        <span class="text-sm">üíª Freelance</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                        <input type="checkbox" value="investimentos" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                                        <span class="text-sm">üìà Investimentos</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                        <input type="checkbox" value="vendas" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                                        <span class="text-sm">üí∞ Vendas</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                        <input type="checkbox" value="presente" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                                        <span class="text-sm">üéÅ Presente</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Continuar ap√≥s valor alvo -->
                                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                                    <label class="flex items-start cursor-pointer">
                                        <input type="checkbox" id="metaContinueAfterGoal" class="mt-0.5 w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                        <div class="ml-3">
                                            <span class="text-sm font-medium text-gray-700">Continuar mesmo ap√≥s atingir o valor alvo</span>
                                            <p class="text-xs text-gray-500 mt-1">Se marcado, o dep√≥sito autom√°tico continuar√° ap√≥s a meta ser alcan√ßada.</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Conta -->
                        <div class="border-t pt-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Onde est√° o dinheiro do envelope?</label>

                            <!-- Passo 1: Escolher Conta -->
                            <select id="contaBancoSelectMeta" class="conta-banco-select w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 mb-3">
                                <option value="">Selecione uma conta...</option>
                                <option value="nubank">üè¶ Nubank</option>
                                <option value="inter">üè¶ Inter</option>
                                <option value="picpay">üè¶ PicPay</option>
                            </select>

                            <!-- Passo 2: Escolher Tipo (Corrente ou Caixinha) -->
                            <div id="tipoContaContainerMeta" class="tipo-conta-container hidden">
                                <label class="block text-sm text-gray-600 mb-2">Em qual modalidade?</label>
                                <div class="grid grid-cols-2 gap-3 mb-3">
                                    <label class="tipo-conta-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer hover:border-brand-500 transition">
                                        <input type="radio" name="tipoContaMeta" value="corrente" class="mr-2">
                                        <span class="text-sm font-medium">Conta Corrente</span>
                                        <p class="text-xs text-gray-500 ml-6">Saldo em conta corrente</p>
                                    </label>
                                    <label class="tipo-conta-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer hover:border-brand-500 transition">
                                        <input type="radio" name="tipoContaMeta" value="caixinha" class="mr-2">
                                        <span class="text-sm font-medium">Caixinha üíé</span>
                                        <p class="text-xs text-gray-500 ml-6">Com rendimento CDI</p>
                                    </label>
                                </div>

                                <!-- Saldo da conta selecionada -->
                                <div id="saldoInfoMeta" class="saldo-info hidden p-2 bg-blue-50 border border-blue-200 rounded text-xs text-blue-800 mb-3">
                                    <span id="saldoTextMeta" class="saldo-text"></span>
                                </div>

                                <!-- Configura√ß√£o de Rendimento -->
                                <div id="rendimentoConfigMeta" class="rendimento-config hidden p-4 bg-gray-50 border border-gray-200 rounded-lg">
                                    <label class="flex items-center mb-3">
                                        <input type="checkbox" id="temRendimentoMeta" class="tem-rendimento w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                        <span class="ml-2 text-sm font-medium text-gray-700">Configurar rendimento</span>
                                    </label>

                                    <div id="camposRendimentoMeta" class="campos-rendimento hidden space-y-3">
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Percentual do CDI</label>
                                            <div class="relative">
                                                <input type="number" step="0.01" placeholder="100" class="w-full pr-12 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 text-sm">
                                                <span class="absolute right-4 top-2 text-gray-500 text-sm">% CDI</span>
                                            </div>
                                        </div>
                                        <p class="text-xs text-green-700 bg-green-50 border border-green-200 rounded p-2">
                                            üí° O rendimento ser√° aplicado automaticamente ao saldo deste envelope.
                                        </p>
                                    </div>
                                </div>

                                <!-- Info se a conta tem rendimento -->
                                <div id="contaTemRendimentoInfoMeta" class="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg hidden">
                                    <p class="text-xs text-green-800">
                                        ‚úÖ A conta <strong id="contaNomeDisplayMeta">Nubank</strong> j√° possui rendimento de <strong id="contaCdiDisplayMeta">100%</strong> do CDI configurado. Este rendimento ser√° aplicado automaticamente a este envelope.
                                    </p>
                                </div>

                                <!-- Hint para Conta Corrente sem rendimento -->
                                <div id="hintCorrenteMeta" class="hint-corrente hidden mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                    <p class="text-xs text-amber-800">
                                        ‚ö†Ô∏è <strong>Aten√ß√£o:</strong> A maioria dos bancos n√£o oferece rendimento em conta corrente. Considere usar uma <strong>caixinha</strong> para que seu dinheiro renda enquanto voc√™ economiza!
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- J√° economizou algum valor? -->
                        <div class="border-t pt-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">J√° economizou algum valor? (opcional)</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3 text-gray-500">R$</span>
                                <input type="number" step="0.01" placeholder="0,00" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Esse valor ser√° transferido da conta para o envelope</p>
                        </div>

                        <!-- Buttons -->
                        <div class="flex space-x-3 pt-6 border-t">
                            <button type="button" onclick="goBackToTypeSelection()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition">
                                Voltar
                            </button>
                            <button type="submit" class="flex-1 bg-brand-500 hover:bg-brand-600 text-white py-3 rounded-lg font-medium transition">
                                Criar Meta üéØ
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Passo 2: Formul√°rio FUNDO -->
                <div id="createEnvelopeFormFundo" class="hidden">
                    <form id="createFundoForm" class="space-y-6">
                        <!-- Nome do Fundo -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do fundo</label>
                            <input type="text" placeholder="Ex: Reserva de Emerg√™ncia" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                        </div>

                        <!-- Valor Alvo -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor alvo</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3 text-gray-500">R$</span>
                                <input type="number" step="0.01" placeholder="10.000,00" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Quanto voc√™ quer ter neste fundo</p>
                        </div>

                        <!-- √çcone -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Escolha um √≠cone</label>
                            <div class="grid grid-cols-6 sm:grid-cols-8 gap-2">
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üè•">üè•</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üöó">üöó</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üè†">üè†</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üéì">üéì</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="‚úàÔ∏è">‚úàÔ∏è</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üíº">üíº</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üõ°Ô∏è">üõ°Ô∏è</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üí∞">üí∞</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üéÑ">üéÑ</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üéÅ">üéÅ</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="üìö">üìö</button>
                                <button type="button" class="icon-option w-12 h-12 text-2xl border-2 border-gray-300 rounded-lg hover:border-brand-500 focus:outline-none transition" data-icon="‚ö°">‚ö°</button>
                            </div>
                        </div>

                        <!-- Dep√≥sito Autom√°tico -->
                        <div class="border-t pt-6">
                            <div class="flex items-center mb-4">
                                <input type="checkbox" id="depositoAutoFundo" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                <label for="depositoAutoFundo" class="ml-2 text-sm font-medium text-gray-700">Dep√≥sito autom√°tico</label>
                            </div>
                            <div id="depositoAutoFieldsFundo" class="space-y-4 hidden">
                                <!-- Tipo de Dep√≥sito -->
                                <div>
                                    <label class="block text-sm text-gray-700 font-medium mb-3">Quando depositar?</label>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <label class="border-2 border-gray-300 rounded-lg p-3 cursor-pointer hover:border-brand-500 transition">
                                            <input type="radio" name="tipoDepositoFundo" value="frequencia" class="mr-2" checked>
                                            <span class="text-sm font-medium">Por frequ√™ncia</span>
                                            <p class="text-xs text-gray-500 ml-6">Todo dia X, toda semana, etc</p>
                                        </label>
                                        <label class="border-2 border-gray-300 rounded-lg p-3 cursor-pointer hover:border-brand-500 transition">
                                            <input type="radio" name="tipoDepositoFundo" value="receita" class="mr-2">
                                            <span class="text-sm font-medium">Quando receber</span>
                                            <p class="text-xs text-gray-500 ml-6">Ao receber sal√°rio ou receitas</p>
                                        </label>
                                    </div>
                                </div>

                                <!-- Campos Frequ√™ncia -->
                                <div id="camposFrequenciaFundo" class="space-y-4">
                                    <!-- Valor -->
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-2">Valor do dep√≥sito</label>
                                        <div class="relative">
                                            <span class="absolute left-4 top-3 text-gray-500">R$</span>
                                            <input type="number" step="0.01" id="createFundoValorFixo" placeholder="500,00" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-brand-500">
                                        </div>
                                    </div>

                                    <!-- Bloco de Repeti√ß√£o (igual edi√ß√£o) -->
                                    <div class="p-4 bg-gray-50 rounded-xl space-y-4">
                                        <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Repetir</p>

                                        <!-- Frequ√™ncia -->
                                        <div>
                                            <select id="createFundoFrequencia" class="frequencia-select w-full px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent bg-white font-medium" data-prefix="createFundo">
                                                <option value="diaria">Todo dia</option>
                                                <option value="semanal">Toda semana</option>
                                                <option value="quinzenal">A cada 15 dias</option>
                                                <option value="mensal" selected>Todo m√™s</option>
                                                <option value="trimestral">A cada 3 meses</option>
                                                <option value="anual">Todo ano</option>
                                            </select>
                                        </div>

                                        <!-- Op√ß√µes Mensal/Trimestral/Anual -->
                                        <div id="createFundo-opcoes-mensal" class="space-y-3">
                                            <div>
                                                <label class="block text-xs text-gray-500 mb-1.5">Quando</label>
                                                <select id="createFundo-quando-mensal" class="quando-mensal-select w-full px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent bg-white" data-prefix="createFundo">
                                                    <option value="dia" selected>Dia espec√≠fico</option>
                                                    <option value="primeiro">Primeiro dia do m√™s</option>
                                                    <option value="ultimo">√öltimo dia do m√™s</option>
                                                    <option value="primeiro-util">Primeiro dia √∫til</option>
                                                    <option value="ultimo-util">√öltimo dia √∫til</option>
                                                </select>
                                            </div>

                                            <!-- Campo para dia espec√≠fico -->
                                            <div id="createFundo-dia-especifico-container" class="flex items-center gap-3">
                                                <div class="flex-1">
                                                    <label class="block text-xs text-gray-500 mb-1.5">Dia</label>
                                                    <input type="number" id="createFundoDia" min="1" max="28" value="5" class="w-full px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent bg-white font-medium">
                                                </div>
                                                <div class="flex-1">
                                                    <label class="block text-xs text-gray-500 mb-1.5">&nbsp;</label>
                                                    <label class="flex items-center h-[46px] px-4 bg-white border border-gray-300 rounded-xl cursor-pointer hover:bg-gray-50">
                                                        <input type="checkbox" id="createFundo-dia-util-check" class="mr-2 text-brand-600 focus:ring-brand-500 rounded">
                                                        <span class="text-sm text-gray-700">Dia √∫til</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Op√ß√µes Semanal/Quinzenal -->
                                        <div id="createFundo-opcoes-semanal" class="hidden">
                                            <label class="block text-xs text-gray-500 mb-1.5">No dia</label>
                                            <select id="createFundo-dia-semana" class="w-full px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent bg-white">
                                                <option value="domingo">Domingo</option>
                                                <option value="segunda" selected>Segunda-feira</option>
                                                <option value="terca">Ter√ßa-feira</option>
                                                <option value="quarta">Quarta-feira</option>
                                                <option value="quinta">Quinta-feira</option>
                                                <option value="sexta">Sexta-feira</option>
                                                <option value="sabado">S√°bado</option>
                                            </select>
                                        </div>

                                        <!-- Op√ß√µes Di√°ria -->
                                        <div id="createFundo-opcoes-diaria" class="hidden">
                                            <label class="flex items-center p-3 bg-white rounded-xl border border-gray-200 cursor-pointer hover:bg-gray-50">
                                                <input type="checkbox" id="createFundo-apenas-dias-uteis" class="mr-3 text-brand-600 focus:ring-brand-500 rounded">
                                                <div>
                                                    <span class="text-sm font-medium text-gray-700">Apenas dias √∫teis</span>
                                                    <p class="text-xs text-gray-500">Ignora s√°bados, domingos e feriados</p>
                                                </div>
                                            </label>
                                        </div>

                                        <!-- Preview inline -->
                                        <div class="flex items-center justify-between p-3 bg-brand-50 rounded-xl border border-brand-100">
                                            <div class="flex items-center text-sm">
                                                <svg class="w-5 h-5 text-brand-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                                <span class="text-brand-700">Pr√≥ximo dep√≥sito</span>
                                            </div>
                                            <span id="createFundoPreviewInline" class="text-sm font-semibold text-brand-800">05/Fev/2026</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Campos Quando Receber -->
                                <div id="camposReceitaFundo" class="hidden">
                                    <div class="space-y-4">
                                        <div>
                                            <div class="flex items-center justify-between mb-2">
                                                <label class="block text-sm text-gray-600">Quanto depositar?</label>
                                                <!-- Toggle Fixo/Percentual -->
                                                <div class="inline-flex rounded-lg border border-gray-300 p-1 bg-gray-50">
                                                    <button type="button" class="toggle-valor-tipo px-3 py-1 text-xs font-medium rounded transition bg-white shadow-sm text-brand-600" data-tipo="fixo" data-target="fundoReceitaSidebar">
                                                        R$ Fixo
                                                    </button>
                                                    <button type="button" class="toggle-valor-tipo px-3 py-1 text-xs font-medium rounded transition text-gray-600" data-tipo="percentual" data-target="fundoReceitaSidebar">
                                                        % Percentual
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Campo Valor Fixo -->
                                            <div id="valorFixoFundoReceitaSidebar">
                                                <div class="relative">
                                                    <span class="absolute left-4 top-3 text-gray-500">R$</span>
                                                    <input type="number" step="0.01" placeholder="500,00" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500">
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">Valor fixo a ser depositado</p>
                                            </div>

                                            <!-- Campo Percentual -->
                                            <div id="valorPercentualFundoReceitaSidebar" class="hidden">
                                                <div class="relative">
                                                    <input type="number" step="0.01" placeholder="20" class="w-full pr-10 pl-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500">
                                                    <span class="absolute right-4 top-3 text-gray-500">%</span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">Percentual da receita a ser depositado</p>
                                            </div>
                                        </div>

                                        <div>
                                            <label class="block text-sm text-gray-600 mb-2">Aplicar em</label>
                                            <select id="aplicarEmFundoSidebar" class="aplicar-em-select w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500" data-target="seletorCategoriasFundoSidebar">
                                                <option value="todas">Todas as receitas</option>
                                                <option value="categorias">Categorias espec√≠ficas</option>
                                            </select>

                                            <!-- Seletor de Categorias -->
                                            <div id="seletorCategoriasFundoSidebar" class="hidden mt-3">
                                                <label class="block text-xs text-gray-600 mb-2">Selecione as categorias de receita:</label>
                                                <div class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                        <input type="checkbox" value="salario" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                                        <span class="text-sm">üíº Sal√°rio</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                        <input type="checkbox" value="freelance" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                                        <span class="text-sm">üíª Freelance</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                        <input type="checkbox" value="investimentos" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                                        <span class="text-sm">üìà Investimentos</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                        <input type="checkbox" value="vendas" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                                        <span class="text-sm">üí∞ Vendas</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                        <input type="checkbox" value="presente" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                                        <span class="text-sm">üéÅ Presente</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Continuar ap√≥s valor alvo -->
                                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                                    <label class="flex items-start cursor-pointer">
                                        <input type="checkbox" id="fundoContinueAfterGoal" class="mt-0.5 w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                        <div class="ml-3">
                                            <span class="text-sm font-medium text-gray-700">Continuar mesmo ap√≥s atingir o valor alvo</span>
                                            <p class="text-xs text-gray-500 mt-1">Se marcado, o dep√≥sito autom√°tico continuar√° ap√≥s o valor alvo ser alcan√ßado.</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Conta -->
                        <div class="border-t pt-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Onde est√° o dinheiro do envelope?</label>

                            <!-- Passo 1: Escolher Conta -->
                            <select id="contaBancoSelectFundo" class="conta-banco-select w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 mb-3">
                                <option value="">Selecione uma conta...</option>
                                <option value="nubank">üè¶ Nubank</option>
                                <option value="inter">üè¶ Inter</option>
                                <option value="picpay">üè¶ PicPay</option>
                            </select>

                            <!-- Passo 2: Escolher Tipo (Corrente ou Caixinha) -->
                            <div id="tipoContaContainerFundo" class="tipo-conta-container hidden">
                                <label class="block text-sm text-gray-600 mb-2">Em qual modalidade?</label>
                                <div class="grid grid-cols-2 gap-3 mb-3">
                                    <label class="tipo-conta-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer hover:border-brand-500 transition">
                                        <input type="radio" name="tipoContaFundo" value="corrente" class="mr-2">
                                        <span class="text-sm font-medium">Conta Corrente</span>
                                        <p class="text-xs text-gray-500 ml-6">Saldo em conta corrente</p>
                                    </label>
                                    <label class="tipo-conta-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer hover:border-brand-500 transition">
                                        <input type="radio" name="tipoContaFundo" value="caixinha" class="mr-2">
                                        <span class="text-sm font-medium">Caixinha üíé</span>
                                        <p class="text-xs text-gray-500 ml-6">Com rendimento CDI</p>
                                    </label>
                                </div>

                                <!-- Saldo da conta selecionada -->
                                <div id="saldoInfoFundo" class="saldo-info hidden p-2 bg-blue-50 border border-blue-200 rounded text-xs text-blue-800 mb-3">
                                    <span id="saldoTextFundo" class="saldo-text"></span>
                                </div>

                                <!-- Configura√ß√£o de Rendimento -->
                                <div id="rendimentoConfigFundo" class="rendimento-config hidden p-4 bg-gray-50 border border-gray-200 rounded-lg">
                                    <label class="flex items-center mb-3">
                                        <input type="checkbox" id="temRendimentoFundo" class="tem-rendimento w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                        <span class="ml-2 text-sm font-medium text-gray-700">Configurar rendimento</span>
                                    </label>

                                    <div id="camposRendimentoFundo" class="campos-rendimento hidden space-y-3">
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Percentual do CDI</label>
                                            <div class="relative">
                                                <input type="number" step="0.01" placeholder="100" class="w-full pr-12 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 text-sm">
                                                <span class="absolute right-4 top-2 text-gray-500 text-sm">% CDI</span>
                                            </div>
                                        </div>
                                        <p class="text-xs text-green-700 bg-green-50 border border-green-200 rounded p-2">
                                            üí° O rendimento ser√° aplicado automaticamente ao saldo deste envelope.
                                        </p>
                                    </div>
                                </div>

                                <!-- Info se a conta tem rendimento -->
                                <div id="contaTemRendimentoInfoFundo" class="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg hidden">
                                    <p class="text-xs text-green-800">
                                        ‚úÖ A conta <strong id="contaNomeDisplayFundo">Nubank</strong> j√° possui rendimento de <strong id="contaCdiDisplayFundo">100%</strong> do CDI configurado. Este rendimento ser√° aplicado automaticamente a este envelope.
                                    </p>
                                </div>

                                <!-- Hint para Conta Corrente sem rendimento -->
                                <div id="hintCorrenteFundo" class="hint-corrente hidden mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                    <p class="text-xs text-amber-800">
                                        ‚ö†Ô∏è <strong>Aten√ß√£o:</strong> A maioria dos bancos n√£o oferece rendimento em conta corrente. Considere usar uma <strong>caixinha</strong> para que seu dinheiro renda enquanto voc√™ economiza!
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- J√° economizou algum valor? -->
                        <div class="border-t pt-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">J√° tem algum valor neste fundo? (opcional)</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3 text-gray-500">R$</span>
                                <input type="number" step="0.01" placeholder="0,00" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Esse valor ser√° transferido da conta para o envelope</p>
                        </div>

                        <!-- Buttons -->
                        <div class="flex space-x-3 pt-6 border-t">
                            <button type="button" onclick="goBackToTypeSelection()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition">
                                Voltar
                            </button>
                            <button type="submit" class="flex-1 bg-brand-500 hover:bg-brand-600 text-white py-3 rounded-lg font-medium transition">
                                Criar Fundo üí∞
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Depositar -->
    <div id="depositModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Depositar no Envelope</h3>
                <button onclick="closeDepositModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Info do Envelope -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6 border border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="text-3xl" id="depositEnvelopeIcon"></div>
                    <div>
                        <h4 class="font-semibold text-gray-900" id="depositEnvelopeName">Notebook Gamer Dell G15</h4>
                        <p class="text-sm text-gray-500" id="depositEnvelopeAccount">Nubank (Caixinha)</p>
                    </div>
                </div>
            </div>

            <form id="depositForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor do dep√≥sito</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3 text-gray-500">R$</span>
                        <input type="text" id="depositValue" placeholder="0,00" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent text-lg font-semibold" required>
                    </div>
                </div>

                <!-- Valores Sugeridos -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Valores sugeridos</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" onclick="setDepositValue(100)" class="bg-gray-100 hover:bg-brand-50 hover:border-brand-500 border-2 border-transparent text-gray-700 py-2 rounded-lg font-medium text-sm transition">
                            R$ 100
                        </button>
                        <button type="button" onclick="setDepositValue(250)" class="bg-gray-100 hover:bg-brand-50 hover:border-brand-500 border-2 border-transparent text-gray-700 py-2 rounded-lg font-medium text-sm transition">
                            R$ 250
                        </button>
                        <button type="button" onclick="setDepositValue(500)" class="bg-gray-100 hover:bg-brand-50 hover:border-brand-500 border-2 border-transparent text-gray-700 py-2 rounded-lg font-medium text-sm transition">
                            R$ 500
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Origem (opcional)</label>
                    <select id="depositOrigin" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500">
                        <option value="">Selecione...</option>
                        <option value="salario">Salario</option>
                        <option value="freelance">Freelance</option>
                        <option value="presente">Presente</option>
                        <option value="bonus">Bonus</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Observacao (opcional)</label>
                    <textarea id="depositNote" rows="2" placeholder="Ex: Bonus de fim de ano" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent"></textarea>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-xs text-blue-800">
                        O valor sera transferido da sua conta <strong id="depositFromAccount">Nubank</strong> para este envelope.
                    </p>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeDepositModal()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-brand-500 hover:bg-brand-600 text-white py-3 rounded-lg font-medium transition flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>Confirmar Deposito</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Retirar -->
    <div id="withdrawModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Retirar do Envelope</h3>
                <button onclick="closeWithdrawModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Info do Envelope -->
            <div class="bg-gray-50 rounded-lg p-4 mb-4 border border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="text-3xl" id="withdrawEnvelopeIcon"></div>
                    <div>
                        <h4 class="font-semibold text-gray-900" id="withdrawEnvelopeName">Notebook Gamer Dell G15</h4>
                        <p class="text-sm text-gray-500" id="withdrawEnvelopeAccount">Nubank (Caixinha)</p>
                    </div>
                </div>
            </div>

            <!-- Saldo Disponivel -->
            <div class="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-center justify-between">
                <span class="text-sm text-amber-800 font-medium">Saldo disponivel:</span>
                <span class="text-lg font-bold text-amber-900" id="withdrawAvailableBalance">R$ 2.500,00</span>
            </div>

            <form id="withdrawForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor da retirada</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3 text-gray-500">R$</span>
                        <input type="text" id="withdrawValue" placeholder="0,00" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent text-lg font-semibold" required>
                    </div>
                </div>

                <!-- Valores Rapidos -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Retirar</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" onclick="setWithdrawValue(50)" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg font-medium text-sm transition">
                            50%
                        </button>
                        <button type="button" onclick="setWithdrawValue(100)" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg font-medium text-sm transition">
                            100% (Tudo)
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Motivo da retirada (opcional)</label>
                    <textarea id="withdrawNote" rows="2" placeholder="Ex: Emergencia, realocacao, compra do objetivo..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent"></textarea>
                </div>

                <!-- Alerta para META -->
                <div id="withdrawAlertMeta" class="bg-red-50 border border-red-200 rounded-lg p-3">
                    <p class="text-xs text-red-800">
                        O valor sera devolvido para sua conta <strong id="withdrawToAccountMeta">Nubank</strong>. Isso pode atrasar o alcance da sua meta.
                    </p>
                </div>

                <!-- Alerta para FUNDO -->
                <div id="withdrawAlertFundo" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-xs text-blue-800">
                        O valor sera devolvido para sua conta <strong id="withdrawToAccountFundo">Nubank</strong>.
                    </p>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeWithdrawModal()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-medium transition flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                        </svg>
                        <span>Confirmar Retirada</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Editar Valor Alvo -->
    <div id="editGoalModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Editar Valor Alvo</h3>
                <button onclick="closeEditGoalModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Info do Envelope -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6 border border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="text-3xl" id="editGoalEnvelopeIcon"></div>
                    <div>
                        <h4 class="font-semibold text-gray-900" id="editGoalEnvelopeName"></h4>
                        <p class="text-sm text-gray-500" id="editGoalEnvelopeType"></p>
                    </div>
                </div>
            </div>

            <form id="editGoalForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Novo valor alvo</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3 text-gray-500">R$</span>
                        <input type="text" id="editGoalValue" placeholder="0,00" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent text-lg font-semibold" required>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Valor atual: <span id="editGoalCurrentValue" class="font-semibold"></span></p>
                </div>

                <!-- Valores Sugeridos -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Valores sugeridos</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" onclick="setGoalValue(1000)" class="bg-gray-100 hover:bg-brand-50 hover:border-brand-500 border-2 border-transparent text-gray-700 py-2 rounded-lg font-medium text-sm transition">
                            R$ 1.000
                        </button>
                        <button type="button" onclick="setGoalValue(5000)" class="bg-gray-100 hover:bg-brand-50 hover:border-brand-500 border-2 border-transparent text-gray-700 py-2 rounded-lg font-medium text-sm transition">
                            R$ 5.000
                        </button>
                        <button type="button" onclick="setGoalValue(10000)" class="bg-gray-100 hover:bg-brand-50 hover:border-brand-500 border-2 border-transparent text-gray-700 py-2 rounded-lg font-medium text-sm transition">
                            R$ 10.000
                        </button>
                    </div>
                </div>

                <!-- Info sobre impacto -->
                <div id="editGoalImpactInfo" class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-xs text-blue-800">
                        Alterar o valor alvo pode afetar o c√°lculo de quanto falta para atingir a meta e o valor sugerido para dep√≥sito autom√°tico.
                    </p>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeEditGoalModal()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-brand-500 hover:bg-brand-600 text-white py-3 rounded-lg font-medium transition flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>Salvar</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Sidebar de Detalhes do Envelope -->
    <div id="envelopeSidebar" class="fixed inset-0 z-50 hidden">
        <!-- Overlay -->
        <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closeEnvelopeDetails()"></div>

        <!-- Sidebar -->
        <div class="sidebar-detalhes absolute right-0 top-0 h-full w-full md:w-2/3 lg:w-1/2 bg-white shadow-2xl overflow-y-auto">
            <!-- Header Dinamico -->
            <div id="sidebarHeader" class="sticky top-0 bg-white border-b border-gray-200 p-6 z-10">
                <!-- Preenchido via JavaScript -->
            </div>

            <!-- Content Dinamico -->
            <div id="sidebarContent" class="p-6 space-y-6">
                <!-- Preenchido via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Sidebar de Hist√≥rico Completo -->
    <div id="historicoSidebar" class="fixed inset-0 z-[55] hidden">
        <!-- Overlay -->
        <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closeHistoricoSidebar()"></div>

        <!-- Sidebar -->
        <div class="sidebar-detalhes absolute right-0 top-0 h-full w-full md:w-2/3 lg:w-1/2 bg-white shadow-2xl overflow-y-auto">
            <!-- Header -->
            <div class="sticky top-0 bg-white border-b border-gray-200 p-6 z-10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button onclick="closeHistoricoSidebar()" class="text-gray-400 hover:text-gray-600 p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Hist√≥rico de Movimenta√ß√µes</h2>
                            <p class="text-sm text-gray-500" id="historicoEnvelopeName"></p>
                        </div>
                    </div>
                    <button onclick="closeHistoricoSidebar()" class="text-gray-400 hover:text-gray-600 p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Tabs de Filtro -->
                <div class="flex border-b border-gray-200 mt-4">
                    <button onclick="filterHistorico('todos')" class="historico-filter-btn active flex-1 px-4 py-3 text-sm font-medium text-brand-600 border-b-2 border-brand-500" data-filter="todos">
                        Todos
                    </button>
                    <button onclick="filterHistorico('depositos')" class="historico-filter-btn flex-1 px-4 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300" data-filter="depositos">
                        Dep√≥sitos
                    </button>
                    <button onclick="filterHistorico('retiradas')" class="historico-filter-btn flex-1 px-4 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300" data-filter="retiradas">
                        Retiradas
                    </button>
                </div>
            </div>

            <!-- Resumo -->
            <div class="p-6 bg-gray-50 border-b">
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <p class="text-xs text-gray-500 mb-1">Total Depositado</p>
                        <p class="text-lg font-bold text-green-600" id="historicoTotalDepositos">R$ 0,00</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 mb-1">Total Retirado</p>
                        <p class="text-lg font-bold text-red-600" id="historicoTotalRetiradas">R$ 0,00</p>
                    </div>
                </div>
            </div>

            <!-- Lista de Transa√ß√µes -->
            <div class="p-6">
                <div id="historicoTransactionsList" class="space-y-3">
                    <!-- Preenchido via JavaScript -->
                </div>

                <!-- Estado vazio -->
                <div id="historicoEmptyState" class="hidden text-center py-12">
                    <div class="text-4xl mb-3">üì≠</div>
                    <p class="text-gray-500">Nenhuma movimenta√ß√£o encontrada</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Produto Rastreado -->
    <div id="editProductModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">üéØ Editar Produto</h3>
                <button onclick="closeEditProductModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="editProductForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do produto</label>
                    <input type="text" id="editProductName" value="Notebook Gamer Dell G15" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Link de compra</label>
                    <input type="url" id="editProductUrl" value="https://amazon.com.br/notebook-dell-g15" placeholder="https://..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">Cole o link da loja onde pretende comprar o produto</p>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="editAlertPreco" checked class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                    <label for="editAlertPreco" class="ml-2 text-sm text-gray-700">Alertar quando o pre√ßo mudar</label>
                </div>

                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                    <p class="text-xs text-amber-800">
                        <strong>Em breve:</strong> O sistema vai acompanhar automaticamente o pre√ßo do produto e buscar promo√ß√µes para voc√™!
                    </p>
                </div>

                <!-- Bot√£o para remover produto (s√≥ aparece se houver produto vinculado) -->
                <div id="removeProductSection" class="border-t pt-4 hidden">
                    <button type="button" onclick="removeProduct()" class="w-full text-red-600 hover:text-red-700 text-sm font-medium py-2 flex items-center justify-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        <span>Remover produto vinculado</span>
                    </button>
                </div>

                <div class="flex space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeEditProductModal()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-brand-500 hover:bg-brand-600 text-white py-3 rounded-lg font-medium transition">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Editar Conta Vinculada -->
    <div id="editAccountModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Editar Conta Vinculada</h3>
                <button onclick="closeEditAccountModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Info do Envelope -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6 border border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="text-3xl" id="editAccountEnvelopeIcon"></div>
                    <div>
                        <h4 class="font-semibold text-gray-900" id="editAccountEnvelopeName"></h4>
                        <p class="text-sm text-gray-500">Conta atual: <span id="editAccountCurrentAccount" class="font-medium text-gray-700"></span></p>
                    </div>
                </div>
            </div>

            <form id="editAccountForm" class="space-y-4">
                <!-- Passo 1: Escolher Banco -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Onde est√° o dinheiro do envelope?</label>
                    <select id="editAccountBancoSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 mb-3">
                        <option value="">Selecione uma conta...</option>
                        <option value="nubank">üè¶ Nubank</option>
                        <option value="inter">üè¶ Inter</option>
                        <option value="picpay">üè¶ PicPay</option>
                    </select>

                    <!-- Passo 2: Escolher Tipo (Corrente ou Caixinha) -->
                    <div id="editAccountTipoContainer" class="hidden">
                        <label class="block text-sm text-gray-600 mb-2">Em qual modalidade?</label>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <label id="editAccountTipoCorrente" class="tipo-conta-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer hover:border-brand-500 transition">
                                <input type="radio" name="editTipoConta" value="corrente" class="mr-2">
                                <span class="text-sm font-medium">Conta Corrente</span>
                                <p class="text-xs text-gray-500 ml-6">Saldo em conta corrente</p>
                            </label>
                            <label id="editAccountTipoCaixinha" class="tipo-conta-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer hover:border-brand-500 transition">
                                <input type="radio" name="editTipoConta" value="caixinha" class="mr-2">
                                <span class="text-sm font-medium">Caixinha üíé</span>
                                <p class="text-xs text-gray-500 ml-6">Com rendimento CDI</p>
                            </label>
                        </div>

                        <!-- Saldo da conta selecionada -->
                        <div id="editAccountSaldoInfo" class="hidden p-2 bg-blue-50 border border-blue-200 rounded text-xs text-blue-800 mb-3">
                            <span id="editAccountSaldoText"></span>
                        </div>

                        <!-- Info se a conta tem rendimento -->
                        <div id="editAccountRendimentoInfo" class="hidden mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                            <p class="text-xs text-green-800">
                                ‚úÖ A conta <strong id="editAccountContaNome">Nubank</strong> j√° possui rendimento de <strong id="editAccountContaCDI">100%</strong> do CDI configurado. Este rendimento ser√° aplicado automaticamente a este envelope.
                            </p>
                        </div>

                        <!-- Configura√ß√£o de Rendimento (aparece quando conta n√£o tem rendimento autom√°tico) -->
                        <div id="editAccountRendimentoConfig" class="hidden p-4 bg-gray-50 border border-gray-200 rounded-lg mt-3">
                            <label class="flex items-center mb-3">
                                <input type="checkbox" id="editAccountTemRendimento" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                <span class="ml-2 text-sm font-medium text-gray-700">Configurar rendimento</span>
                            </label>

                            <div id="editAccountCamposRendimento" class="hidden space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Percentual do CDI</label>
                                    <div class="relative">
                                        <input type="number" id="editAccountCDIInput" step="0.01" placeholder="100" class="w-full pr-12 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 text-sm">
                                        <span class="absolute right-4 top-2 text-gray-500 text-sm">% CDI</span>
                                    </div>
                                </div>
                                <p class="text-xs text-green-700 bg-green-50 border border-green-200 rounded p-2">
                                    üí° O rendimento ser√° aplicado automaticamente ao saldo deste envelope.
                                </p>
                            </div>
                        </div>

                        <!-- Hint para Conta Corrente sem rendimento -->
                        <div id="editAccountHintCorrente" class="hidden mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                            <p class="text-xs text-amber-800">
                                ‚ö†Ô∏è <strong>Aten√ß√£o:</strong> A maioria dos bancos n√£o oferece rendimento em conta corrente. Considere usar uma <strong>caixinha</strong> para que seu dinheiro renda enquanto voc√™ economiza!
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Aviso de transfer√™ncia -->
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                    <div class="flex items-start space-x-2">
                        <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <div class="text-xs text-amber-800">
                            <strong>Aten√ß√£o:</strong> Ao trocar a conta vinculada, o saldo do envelope (<span id="editAccountEnvelopeBalance" class="font-semibold"></span>) ser√° transferido automaticamente para a nova conta.
                        </div>
                    </div>
                </div>

                <!-- Aviso de dep√≥sito autom√°tico -->
                <div id="editAccountAutoDepositWarning" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="flex items-start space-x-2">
                        <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="text-xs text-blue-800">
                            <strong>Dep√≥sito autom√°tico:</strong> Os dep√≥sitos autom√°ticos configurados passar√£o a ser feitos a partir da nova conta.
                        </div>
                    </div>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeEditAccountModal()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-brand-500 hover:bg-brand-600 text-white py-3 rounded-lg font-medium transition flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>Salvar</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Estado atual do envelope selecionado
        let currentEnvelope = {
            id: 'notebook',
            name: 'Notebook Gamer Dell G15',
            icon: 'üíª',
            account: 'Nubank (Caixinha)',
            balance: 2500,
            type: 'META'
        };

        // Dados mock dos envelopes
        const envelopesData = {
            'ipva': {
                id: 'ipva',
                name: 'IPVA 2026',
                icon: 'üöó',
                account: 'Nubank',
                accountType: 'Conta Corrente',
                balance: 800,
                goal: 1000,
                type: 'FUNDO',
                autoDeposit: { enabled: true, type: 'frequencia', value: 100, frequency: 'Mensal', day: 5, nextDate: '05/01/2026' },
                rendimento: { enabled: false },
                prediction: 'Mar√ßo/2026',
                monthlyTarget: 100,
                transactions: [
                    { type: 'deposit', description: 'Dep√≥sito Autom√°tico', date: '05/12/2024', time: '10:00', value: 100, category: 'auto' },
                    { type: 'deposit', description: 'Dep√≥sito Autom√°tico', date: '05/11/2024', time: '10:00', value: 100, category: 'auto' },
                    { type: 'deposit', description: 'Dep√≥sito Manual', date: '20/10/2024', time: '15:30', value: 200, category: 'manual' },
                    { type: 'deposit', description: 'Dep√≥sito Autom√°tico', date: '05/10/2024', time: '10:00', value: 100, category: 'auto' },
                    { type: 'deposit', description: 'Dep√≥sito Inicial', date: '15/09/2024', time: '18:00', value: 300, category: 'manual' }
                ]
            },
            'emergencia': {
                id: 'emergencia',
                name: 'Reserva de Emerg√™ncia',
                icon: 'üè•',
                account: 'Nubank',
                accountType: 'Caixinha',
                balance: 1000,
                goal: 1000,
                type: 'FUNDO',
                autoDeposit: { enabled: true, type: 'receita', value: 10, isPercent: true, appliesTo: 'Sal√°rio', nextDate: 'Pr√≥ximo sal√°rio' },
                rendimento: { enabled: true, cdi: 100, total: 25.00 },
                prediction: null,
                monthlyTarget: 0,
                transactions: [
                    { type: 'deposit', description: 'Dep√≥sito Autom√°tico', date: '05/12/2024', time: '10:00', value: 150, category: 'auto', note: '10% do sal√°rio' },
                    { type: 'deposit', description: 'Dep√≥sito Autom√°tico', date: '05/11/2024', time: '10:00', value: 150, category: 'auto', note: '10% do sal√°rio' },
                    { type: 'withdraw', description: 'Retirada', date: '18/11/2024', time: '14:30', value: 200, category: 'manual', note: 'Emerg√™ncia m√©dica' },
                    { type: 'deposit', description: 'Dep√≥sito Manual', date: '10/10/2024', time: '09:00', value: 500, category: 'manual' },
                    { type: 'deposit', description: 'Dep√≥sito Inicial', date: '01/10/2024', time: '12:00', value: 400, category: 'manual' }
                ]
            },
            'notebook': {
                id: 'notebook',
                name: 'Notebook Gamer Dell G15',
                icon: 'üíª',
                account: 'Nubank (Caixinha)',
                accountType: 'Caixinha',
                balance: 2500,
                goal: 5000,
                type: 'META',
                hasProduct: true,
                product: {
                    name: 'Notebook Gamer Dell G15',
                    url: 'https://amazon.com.br/notebook-dell-g15',
                    currentPrice: 4999,
                    initialPrice: 5299,
                    variation: -300
                },
                autoDeposit: { enabled: true, type: 'frequencia', value: 833, frequency: 'Mensal', day: 5, nextDate: '05/01/2026' },
                rendimento: { enabled: true, cdi: 100, total: 48.50 },
                prediction: 'Abril/2026',
                monthlyTarget: 833,
                transactions: [
                    { type: 'deposit', description: 'Dep√≥sito Autom√°tico', date: '05/12/2024', time: '10:00', value: 833, category: 'auto' },
                    { type: 'deposit', description: 'Dep√≥sito Manual', date: '15/11/2024', time: '14:22', value: 500, category: 'manual', note: 'B√¥nus de freelance' },
                    { type: 'withdraw', description: 'Retirada', date: '08/11/2024', time: '09:15', value: 200, category: 'manual', note: 'Precisei cobrir uma conta' },
                    { type: 'deposit', description: 'Dep√≥sito Autom√°tico', date: '05/11/2024', time: '10:00', value: 833, category: 'auto' },
                    { type: 'deposit', description: 'Dep√≥sito Autom√°tico', date: '05/10/2024', time: '10:00', value: 833, category: 'auto' },
                    { type: 'deposit', description: 'Dep√≥sito Manual', date: '20/09/2024', time: '16:45', value: 300, category: 'manual' },
                    { type: 'deposit', description: 'Dep√≥sito Inicial', date: '10/09/2024', time: '18:30', value: 1000, category: 'manual' }
                ]
            },
            'viagem': {
                id: 'viagem',
                name: 'Viagem Europa 2026',
                icon: '‚úàÔ∏è',
                account: 'Inter (Caixinha)',
                accountType: 'Caixinha',
                balance: 3200,
                goal: 15000,
                type: 'META',
                hasProduct: false,
                autoDeposit: { enabled: true, type: 'frequencia', value: 1500, frequency: 'Mensal', day: 10, nextDate: '10/01/2026' },
                rendimento: { enabled: true, cdi: 100, total: 120.00 },
                prediction: 'Setembro/2026',
                monthlyTarget: 1475,
                transactions: [
                    { type: 'deposit', description: 'Dep√≥sito Autom√°tico', date: '10/12/2024', time: '10:00', value: 1500, category: 'auto' },
                    { type: 'deposit', description: 'Dep√≥sito Autom√°tico', date: '10/11/2024', time: '10:00', value: 1500, category: 'auto' },
                    { type: 'deposit', description: 'Dep√≥sito Manual', date: '25/10/2024', time: '11:30', value: 500, category: 'manual', note: 'Sobra do m√™s' },
                    { type: 'deposit', description: 'Dep√≥sito Autom√°tico', date: '10/10/2024', time: '10:00', value: 1500, category: 'auto' },
                    { type: 'withdraw', description: 'Retirada', date: '05/10/2024', time: '08:00', value: 500, category: 'manual', note: 'Imprevisto financeiro' },
                    { type: 'deposit', description: 'Dep√≥sito Inicial', date: '01/09/2024', time: '10:00', value: 2000, category: 'manual' }
                ]
            }
        };

        // Formatar valor em reais
        function formatCurrency(value) {
            return 'R$ ' + value.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        }

        // Renderizar header da sidebar
        function renderSidebarHeader(env) {
            const percent = Math.round((env.balance / env.goal) * 100);
            const remaining = env.goal - env.balance;
            const typeLabel = env.type === 'META' ? 'META' : 'FUNDO';
            const typeBgColor = env.type === 'META' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';

            return `
                <div class="flex items-start justify-between">
                    <div class="flex items-start space-x-4">
                        <div class="text-4xl">${env.icon}</div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">${env.name}</h2>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs ${typeBgColor} px-3 py-1 rounded-full">${typeLabel}</span>
                                <span class="text-sm text-gray-600">${env.account}</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="closeEnvelopeDetails()" class="text-gray-400 hover:text-gray-600 p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Progress Bar -->
                <div class="mt-4">
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-gray-600">${formatCurrency(env.balance)} de ${formatCurrency(env.goal)} ${remaining > 0 ? `<span class="text-gray-400">‚Ä¢ Falta ${formatCurrency(remaining)}</span>` : ''}</span>
                        <span class="text-brand-600 font-bold">${percent}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-brand-500 h-3 rounded-full transition-all duration-500" style="width: ${Math.min(percent, 100)}%"></div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-2 mt-4">
                    <button onclick="openDepositModal('${env.id}')" class="flex-1 bg-brand-500 hover:bg-brand-600 text-white px-4 py-2 rounded-lg font-medium text-sm transition">
                        Depositar
                    </button>
                    <button onclick="openWithdrawModal('${env.id}')" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium text-sm transition">
                        Retirar
                    </button>
                </div>
            `;
        }

        // Renderizar conteudo para FUNDO
        function renderFundoContent(env) {
            const remaining = env.goal - env.balance;
            const autoDepositInfo = env.autoDeposit.type === 'frequencia'
                ? `${env.autoDeposit.frequency}, dia ${env.autoDeposit.day}`
                : `${env.autoDeposit.value}% quando receber ${env.autoDeposit.appliesTo || ''}`;

            const showPrediction = remaining > 0 && env.prediction;

            return `
                <!-- Informacoes do Fundo -->
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 cursor-pointer hover:border-brand-300 hover:bg-gray-100 transition group" onclick="openEditGoalModal()">
                        <div class="flex items-center justify-between">
                            <p class="text-xs text-gray-500 mb-1">Valor Alvo</p>
                            <svg class="w-4 h-4 text-gray-400 group-hover:text-brand-500 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                            </svg>
                        </div>
                        <p class="text-lg font-bold text-gray-900">${formatCurrency(env.goal)}</p>
                    </div>
                    ${showPrediction ? `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                            <p class="text-xs text-blue-600 mb-1">Previsao</p>
                            <p class="text-lg font-bold text-blue-700">${env.prediction}</p>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                            <p class="text-xs text-purple-600 mb-1">Guardar/mes</p>
                            <p class="text-lg font-bold text-purple-700">${formatCurrency(env.monthlyTarget || 0)}</p>
                        </div>
                    </div>
                    ` : ''}
                </div>

                ${renderContaVinculada(env)}

                <!-- Deposito Automatico -->
                <div class="border-t pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Deposito Automatico</h3>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" ${env.autoDeposit.enabled ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                        </label>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Tipo</span>
                            <span class="font-medium text-gray-900">${env.autoDeposit.type === 'frequencia' ? 'Por frequencia' : 'Quando receber'}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Valor</span>
                            <span class="font-medium text-gray-900">${env.autoDeposit.isPercent ? env.autoDeposit.value + '%' : formatCurrency(env.autoDeposit.value)}</span>
                        </div>
                        ${env.autoDeposit.type === 'frequencia' ? `
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Frequencia</span>
                            <span class="font-medium text-gray-900">${env.autoDeposit.frequency}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Dia</span>
                            <span class="font-medium text-gray-900">Todo dia ${env.autoDeposit.day}</span>
                        </div>
                        ` : `
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Aplica em</span>
                            <span class="font-medium text-gray-900">${env.autoDeposit.appliesTo || 'Todas receitas'}</span>
                        </div>
                        `}
                        <div class="flex justify-between text-sm pt-3 border-t">
                            <span class="text-gray-600">Proximo deposito</span>
                            <span class="font-semibold text-brand-600">${env.autoDeposit.nextDate}</span>
                        </div>
                    </div>

                    <button onclick="openEditAutoDepositModal()" class="w-full mt-3 bg-white hover:bg-gray-50 border border-gray-300 text-gray-700 py-2 rounded-lg font-medium text-sm transition">
                        Editar Configuracao
                    </button>
                </div>

                ${renderHistorico()}
            `;
        }

        // Renderizar conteudo para META com produto
        function renderMetaComProdutoContent(env) {
            const remaining = env.goal - env.balance;

            return `
                <!-- Stats -->
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 cursor-pointer hover:border-brand-300 hover:bg-gray-100 transition group" onclick="openEditGoalModal()">
                        <div class="flex items-center justify-between">
                            <p class="text-xs text-gray-500 mb-1">Valor Alvo</p>
                            <svg class="w-4 h-4 text-gray-400 group-hover:text-brand-500 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                            </svg>
                        </div>
                        <p class="text-lg font-bold text-gray-900">${formatCurrency(env.goal)}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                            <p class="text-xs text-blue-600 mb-1">Previsao</p>
                            <p class="text-lg font-bold text-blue-700">${env.prediction || 'Calculando...'}</p>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                            <p class="text-xs text-purple-600 mb-1">Guardar/mes</p>
                            <p class="text-lg font-bold text-purple-700">${formatCurrency(env.monthlyTarget || 0)}</p>
                        </div>
                    </div>
                </div>

                <!-- Produto Rastreado -->
                <div class="border-t pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Produto Rastreado</h3>
                        <button onclick="openEditProductModal()" class="text-sm text-brand-600 hover:text-brand-700 font-medium">Editar</button>
                    </div>

                    <div class="space-y-3">
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-1">${env.product.name}</h4>
                            <a href="${env.product.url}" target="_blank" class="text-xs text-blue-600 hover:underline flex items-center">
                                Ver na loja
                                <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Preco Atual</span>
                                <span class="font-bold text-gray-900">${formatCurrency(env.product.currentPrice)}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Preco Inicial</span>
                                <span class="text-gray-700">${formatCurrency(env.product.initialPrice)}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Variacao</span>
                                <span class="font-semibold ${env.product.variation < 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${env.product.variation < 0 ? '‚Üì' : '‚Üë'} ${formatCurrency(Math.abs(env.product.variation))}
                                </span>
                            </div>
                        </div>

                        <div class="flex items-start space-x-2 bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-xs text-blue-800">
                                <strong>Alerta ativo:</strong> Voce sera notificado quando o preco mudar.
                            </p>
                        </div>
                    </div>
                </div>

                ${renderContaVinculada(env)}
                ${renderDepositoAutomaticoMeta(env)}
                ${renderHistorico()}
            `;
        }

        // Renderizar conteudo para META sem produto
        function renderMetaSemProdutoContent(env) {
            const remaining = env.goal - env.balance;

            return `
                <!-- Stats -->
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 cursor-pointer hover:border-brand-300 hover:bg-gray-100 transition group" onclick="openEditGoalModal()">
                        <div class="flex items-center justify-between">
                            <p class="text-xs text-gray-500 mb-1">Valor Alvo</p>
                            <svg class="w-4 h-4 text-gray-400 group-hover:text-brand-500 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                            </svg>
                        </div>
                        <p class="text-lg font-bold text-gray-900">${formatCurrency(env.goal)}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                            <p class="text-xs text-blue-600 mb-1">Previsao</p>
                            <p class="text-lg font-bold text-blue-700">${env.prediction || 'Calculando...'}</p>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                            <p class="text-xs text-purple-600 mb-1">Guardar/mes</p>
                            <p class="text-lg font-bold text-purple-700">${formatCurrency(env.monthlyTarget || 0)}</p>
                        </div>
                    </div>
                </div>

                <!-- Vincular Produto -->
                <div class="border-t pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Produto</h3>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-6 border-2 border-dashed border-gray-300 text-center">
                        <div class="text-4xl mb-3">üõí</div>
                        <p class="text-sm text-gray-600 mb-3">Vincule um produto para acompanhar o preco</p>
                        <button onclick="openEditProductModal()" class="bg-brand-500 hover:bg-brand-600 text-white px-4 py-2 rounded-lg font-medium text-sm transition">
                            Vincular Produto
                        </button>
                    </div>
                </div>

                ${renderContaVinculada(env)}
                ${renderDepositoAutomaticoMeta(env)}
                ${renderHistorico()}
            `;
        }

        // Renderizar deposito automatico para META
        function renderDepositoAutomaticoMeta(env) {
            return `
                <div class="border-t pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Deposito Automatico</h3>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" ${env.autoDeposit.enabled ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                        </label>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Tipo</span>
                            <span class="font-medium text-gray-900">${env.autoDeposit.type === 'frequencia' ? 'Por frequencia' : 'Quando receber'}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Valor</span>
                            <span class="font-medium text-gray-900">${formatCurrency(env.autoDeposit.value)}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Frequencia</span>
                            <span class="font-medium text-gray-900">${env.autoDeposit.frequency}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Dia</span>
                            <span class="font-medium text-gray-900">Todo dia ${env.autoDeposit.day}</span>
                        </div>
                        <div class="flex justify-between text-sm pt-3 border-t">
                            <span class="text-gray-600">Proximo deposito</span>
                            <span class="font-semibold text-brand-600">${env.autoDeposit.nextDate}</span>
                        </div>
                    </div>

                    <button onclick="openEditAutoDepositModal()" class="w-full mt-3 bg-white hover:bg-gray-50 border border-gray-300 text-gray-700 py-2 rounded-lg font-medium text-sm transition">
                        Editar Configuracao
                    </button>
                </div>
            `;
        }

        // Renderizar se√ß√£o de Conta Vinculada (reutiliz√°vel)
        function renderContaVinculada(env) {
            return `
                <div class="border-t pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Conta Vinculada</h3>
                        <button onclick="openEditAccountModal()" class="text-sm text-brand-600 hover:text-brand-700 font-medium">Editar</button>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Conta</span>
                            <span class="font-medium text-gray-900">${env.account}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Tipo</span>
                            <span class="font-medium text-gray-900">${env.accountType}</span>
                        </div>
                        ${env.rendimento && env.rendimento.enabled ? `
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Rendimento</span>
                            <span class="font-medium text-green-600">${env.rendimento.cdi}% CDI</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Renderizar historico de transacoes (preview com 3 ultimas)
        function renderHistorico() {
            const env = currentEnvelope;
            const transactions = env?.transactions || [];
            const recentTransactions = transactions.slice(0, 3);
            const totalTransactions = transactions.length;

            // Gera HTML das transa√ß√µes recentes
            const transactionsHtml = recentTransactions.map(t => {
                const isDeposit = t.type === 'deposit';

                let bgColor, borderColor, iconBg, iconColor, valueColor, sign;

                if (isDeposit) {
                    bgColor = 'bg-green-50';
                    borderColor = 'border-green-200';
                    iconBg = 'bg-green-100';
                    iconColor = 'text-green-600';
                    valueColor = 'text-green-600';
                    sign = '+';
                } else {
                    bgColor = 'bg-red-50';
                    borderColor = 'border-red-200';
                    iconBg = 'bg-red-100';
                    iconColor = 'text-red-600';
                    valueColor = 'text-red-600';
                    sign = '-';
                }

                // √çcone baseado na categoria
                let icon = isDeposit ? '+' : '-';
                if (t.category === 'auto') {
                    icon = 'üîÑ';
                }

                return `
                    <div class="flex items-center justify-between p-3 ${bgColor} border ${borderColor} rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 ${iconBg} rounded-full flex items-center justify-center ${iconColor} font-semibold text-lg">${icon}</div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">${t.description}</p>
                                <p class="text-xs text-gray-500">${t.date} √†s ${t.time}</p>
                            </div>
                        </div>
                        <span class="text-sm font-bold ${valueColor}">${sign} ${formatCurrency(t.value)}</span>
                    </div>
                `;
            }).join('');

            // Texto do bot√£o "Ver todos"
            const verTodosText = totalTransactions > 3
                ? `Ver todos (${totalTransactions})`
                : 'Ver todos';

            return `
                <div class="border-t pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Hist√≥rico</h3>
                        <button onclick="openHistoricoSidebar()" class="text-sm text-brand-600 hover:text-brand-700 font-medium">${verTodosText}</button>
                    </div>

                    <div class="space-y-3">
                        ${transactionsHtml || '<p class="text-sm text-gray-500 text-center py-4">Nenhuma movimenta√ß√£o ainda</p>'}
                    </div>
                </div>
            `;
        }

        // Abrir detalhes do envelope
        function openEnvelopeDetails(envelopeId) {
            console.log('Abrindo detalhes do envelope:', envelopeId);

            // Define o envelope atual
            if (envelopeId && envelopesData[envelopeId]) {
                currentEnvelope = envelopesData[envelopeId];
            }

            // Renderiza o conteudo baseado no tipo
            const headerEl = document.getElementById('sidebarHeader');
            const contentEl = document.getElementById('sidebarContent');

            headerEl.innerHTML = renderSidebarHeader(currentEnvelope);

            if (currentEnvelope.type === 'FUNDO') {
                contentEl.innerHTML = renderFundoContent(currentEnvelope);
            } else if (currentEnvelope.type === 'META' && currentEnvelope.hasProduct) {
                contentEl.innerHTML = renderMetaComProdutoContent(currentEnvelope);
            } else {
                contentEl.innerHTML = renderMetaSemProdutoContent(currentEnvelope);
            }

            const sidebar = document.getElementById('envelopeSidebar');
            const sidebarContent = sidebar.querySelector('.sidebar-detalhes');

            sidebar.classList.remove('hidden');
            document.body.classList.add('modal-open');

            // Pequeno delay para a animacao funcionar
            setTimeout(() => {
                sidebarContent.classList.add('open');
            }, 10);
        }

        // Fechar detalhes do envelope
        function closeEnvelopeDetails() {
            const sidebar = document.getElementById('envelopeSidebar');
            const sidebarContent = sidebar.querySelector('.sidebar-detalhes');

            sidebarContent.classList.remove('open');

            setTimeout(() => {
                sidebar.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 300);
        }

        // Modal de Depositar
        function openDepositModal(envelopeId) {
            if (envelopeId && envelopesData[envelopeId]) {
                currentEnvelope = envelopesData[envelopeId];
            }

            // Atualiza informa√ß√µes do envelope no modal
            document.getElementById('depositEnvelopeIcon').textContent = currentEnvelope.icon;
            document.getElementById('depositEnvelopeName').textContent = currentEnvelope.name;
            document.getElementById('depositEnvelopeAccount').textContent = currentEnvelope.account;
            document.getElementById('depositFromAccount').textContent = currentEnvelope.account.split(' ')[0];

            // Limpa o formul√°rio
            document.getElementById('depositValue').value = '';
            document.getElementById('depositOrigin').value = '';
            document.getElementById('depositNote').value = '';

            document.getElementById('depositModal').classList.remove('hidden');
            document.body.classList.add('modal-open');

            // Foca no campo de valor
            setTimeout(() => document.getElementById('depositValue').focus(), 100);
        }

        function closeDepositModal() {
            document.getElementById('depositModal').classList.add('hidden');
            document.body.classList.remove('modal-open');
        }

        function setDepositValue(value) {
            document.getElementById('depositValue').value = value.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        }

        // Modal de Retirar
        function openWithdrawModal(envelopeId) {
            if (envelopeId && envelopesData[envelopeId]) {
                currentEnvelope = envelopesData[envelopeId];
            }

            // Atualiza informa√ß√µes do envelope no modal
            document.getElementById('withdrawEnvelopeIcon').textContent = currentEnvelope.icon;
            document.getElementById('withdrawEnvelopeName').textContent = currentEnvelope.name;
            document.getElementById('withdrawEnvelopeAccount').textContent = currentEnvelope.account;
            document.getElementById('withdrawAvailableBalance').textContent = 'R$ ' + currentEnvelope.balance.toLocaleString('pt-BR', { minimumFractionDigits: 2 });

            const accountName = currentEnvelope.account.split(' ')[0];
            document.getElementById('withdrawToAccountMeta').textContent = accountName;
            document.getElementById('withdrawToAccountFundo').textContent = accountName;

            // Mostra alerta correto baseado no tipo
            const alertMeta = document.getElementById('withdrawAlertMeta');
            const alertFundo = document.getElementById('withdrawAlertFundo');

            if (currentEnvelope.type === 'META') {
                alertMeta.classList.remove('hidden');
                alertFundo.classList.add('hidden');
            } else {
                alertMeta.classList.add('hidden');
                alertFundo.classList.remove('hidden');
            }

            // Limpa o formul√°rio
            document.getElementById('withdrawValue').value = '';
            document.getElementById('withdrawNote').value = '';

            document.getElementById('withdrawModal').classList.remove('hidden');
            document.body.classList.add('modal-open');

            // Foca no campo de valor
            setTimeout(() => document.getElementById('withdrawValue').focus(), 100);
        }

        function closeWithdrawModal() {
            document.getElementById('withdrawModal').classList.add('hidden');
            document.body.classList.remove('modal-open');
        }

        // Sidebar de Hist√≥rico Completo
        let currentHistoricoFilter = 'todos';

        function openHistoricoSidebar() {
            const env = currentEnvelope;
            if (!env) return;

            // Atualiza o nome do envelope
            document.getElementById('historicoEnvelopeName').textContent = `${env.icon} ${env.name}`;

            // Calcula totais
            const transactions = env.transactions || [];
            const totalDepositos = transactions
                .filter(t => t.type === 'deposit')
                .reduce((sum, t) => sum + t.value, 0);
            const totalRetiradas = transactions
                .filter(t => t.type === 'withdraw')
                .reduce((sum, t) => sum + t.value, 0);

            document.getElementById('historicoTotalDepositos').textContent = formatCurrency(totalDepositos);
            document.getElementById('historicoTotalRetiradas').textContent = formatCurrency(totalRetiradas);

            // Reset filtro
            currentHistoricoFilter = 'todos';
            updateFilterButtons();

            // Renderiza transa√ß√µes
            renderHistoricoTransactions(transactions);

            // Abre a sidebar
            const sidebar = document.getElementById('historicoSidebar');
            const sidebarContent = sidebar.querySelector('.sidebar-detalhes');

            sidebar.classList.remove('hidden');

            setTimeout(() => {
                sidebarContent.classList.add('open');
            }, 10);
        }

        function closeHistoricoSidebar() {
            const sidebar = document.getElementById('historicoSidebar');
            const sidebarContent = sidebar.querySelector('.sidebar-detalhes');

            sidebarContent.classList.remove('open');

            setTimeout(() => {
                sidebar.classList.add('hidden');
            }, 300);
        }

        function filterHistorico(filter) {
            currentHistoricoFilter = filter;
            updateFilterButtons();

            const env = currentEnvelope;
            if (!env) return;

            let transactions = env.transactions || [];

            // Aplica filtro
            if (filter === 'depositos') {
                transactions = transactions.filter(t => t.type === 'deposit');
            } else if (filter === 'retiradas') {
                transactions = transactions.filter(t => t.type === 'withdraw');
            }

            renderHistoricoTransactions(transactions);
        }

        function updateFilterButtons() {
            document.querySelectorAll('.historico-filter-btn').forEach(btn => {
                const filter = btn.dataset.filter;
                if (filter === currentHistoricoFilter) {
                    btn.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                    btn.classList.add('text-brand-600', 'border-brand-500', 'active');
                } else {
                    btn.classList.add('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                    btn.classList.remove('text-brand-600', 'border-brand-500', 'active');
                }
            });
        }

        function renderHistoricoTransactions(transactions) {
            const container = document.getElementById('historicoTransactionsList');
            const emptyState = document.getElementById('historicoEmptyState');

            if (!transactions || transactions.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            const html = transactions.map(t => {
                const isDeposit = t.type === 'deposit';

                let bgColor, borderColor, iconBg, iconColor, valueColor, sign;

                if (isDeposit) {
                    bgColor = 'bg-green-50';
                    borderColor = 'border-green-200';
                    iconBg = 'bg-green-100';
                    iconColor = 'text-green-600';
                    valueColor = 'text-green-600';
                    sign = '+';
                } else {
                    bgColor = 'bg-red-50';
                    borderColor = 'border-red-200';
                    iconBg = 'bg-red-100';
                    iconColor = 'text-red-600';
                    valueColor = 'text-red-600';
                    sign = '-';
                }

                // √çcone baseado na categoria
                let icon = isDeposit ? '+' : '-';
                if (t.category === 'auto') {
                    icon = 'üîÑ';
                }

                // Badge de categoria
                let categoryBadge = '';
                if (t.category === 'auto') {
                    categoryBadge = '<span class="ml-2 text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded">Autom√°tico</span>';
                }

                return `
                    <div class="flex items-start justify-between p-4 ${bgColor} border ${borderColor} rounded-lg">
                        <div class="flex items-start space-x-3">
                            <div class="w-10 h-10 ${iconBg} rounded-full flex items-center justify-center ${iconColor} font-semibold text-lg flex-shrink-0">
                                ${icon}
                            </div>
                            <div class="min-w-0">
                                <div class="flex items-center flex-wrap">
                                    <p class="text-sm font-medium text-gray-900">${t.description}</p>
                                    ${categoryBadge}
                                </div>
                                <p class="text-xs text-gray-500">${t.date} √†s ${t.time}</p>
                                ${t.note ? `<p class="text-xs text-gray-600 mt-1 italic">"${t.note}"</p>` : ''}
                            </div>
                        </div>
                        <span class="text-sm font-bold ${valueColor} flex-shrink-0 ml-3">${sign} ${formatCurrency(t.value)}</span>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Modal de Editar Produto
        function openEditProductModal() {
            const modal = document.getElementById('editProductModal');
            const removeSection = document.getElementById('removeProductSection');

            // Mostrar bot√£o de remover apenas se o envelope tem produto vinculado
            if (currentEnvelope && currentEnvelope.hasProduct) {
                removeSection.classList.remove('hidden');
                // Preencher campos com dados do produto existente
                document.getElementById('editProductName').value = currentEnvelope.product.name;
                document.getElementById('editProductUrl').value = currentEnvelope.product.url;
            } else {
                removeSection.classList.add('hidden');
                // Limpar campos para novo produto
                document.getElementById('editProductName').value = '';
                document.getElementById('editProductUrl').value = '';
            }

            modal.classList.remove('hidden');
            // Mant√©m o modal-open pois a sidebar j√° o adicionou
        }

        function closeEditProductModal() {
            document.getElementById('editProductModal').classList.add('hidden');
        }

        function removeProduct() {
            if (confirm('Tem certeza que deseja remover o produto vinculado? Isso ir√° desabilitar o rastreamento de pre√ßo.')) {
                alert('Produto removido com sucesso!');
                closeEditProductModal();
            }
        }

        // Modal de Editar Valor Alvo
        function openEditGoalModal() {
            // Atualiza informa√ß√µes do envelope no modal
            document.getElementById('editGoalEnvelopeIcon').textContent = currentEnvelope.icon;
            document.getElementById('editGoalEnvelopeName').textContent = currentEnvelope.name;
            document.getElementById('editGoalEnvelopeType').textContent = currentEnvelope.type;
            document.getElementById('editGoalCurrentValue').textContent = formatCurrency(currentEnvelope.goal);
            document.getElementById('editGoalValue').value = '';

            document.getElementById('editGoalModal').classList.remove('hidden');
            // Mant√©m o modal-open pois a sidebar j√° o adicionou

            // Foca no campo de valor
            setTimeout(() => document.getElementById('editGoalValue').focus(), 100);
        }

        function closeEditGoalModal() {
            document.getElementById('editGoalModal').classList.add('hidden');
        }

        function setGoalValue(value) {
            document.getElementById('editGoalValue').value = value.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        }

        // Handler do formul√°rio de editar valor alvo
        document.getElementById('editGoalForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const newValue = document.getElementById('editGoalValue').value;
            const numericValue = parseFloat(newValue.replace(/\./g, '').replace(',', '.')) || 0;

            if (numericValue <= 0) {
                alert('Por favor, insira um valor maior que zero.');
                return;
            }

            // Atualiza o valor no objeto (simula√ß√£o)
            currentEnvelope.goal = numericValue;

            // Atualiza nos dados mockados
            if (envelopesData[currentEnvelope.id]) {
                envelopesData[currentEnvelope.id].goal = numericValue;
            }

            alert(`Valor alvo atualizado para ${formatCurrency(numericValue)}`);
            closeEditGoalModal();

            // Re-renderiza a sidebar para mostrar o novo valor
            openEnvelopeDetails(currentEnvelope.id);
        });

        // Modal de Editar Conta Vinculada
        function openEditAccountModal() {
            // Atualiza informa√ß√µes do envelope no modal
            document.getElementById('editAccountEnvelopeIcon').textContent = currentEnvelope.icon;
            document.getElementById('editAccountEnvelopeName').textContent = currentEnvelope.name;
            document.getElementById('editAccountCurrentAccount').textContent = currentEnvelope.account;
            document.getElementById('editAccountEnvelopeBalance').textContent = formatCurrency(currentEnvelope.balance);

            // Extrai o banco da conta atual
            const accountName = currentEnvelope.account || '';
            const accountType = currentEnvelope.accountType || '';

            // Mapeia o nome do banco para o value do select
            let bancoValue = '';
            if (accountName.toLowerCase().includes('nubank')) {
                bancoValue = 'nubank';
            } else if (accountName.toLowerCase().includes('inter')) {
                bancoValue = 'inter';
            } else if (accountName.toLowerCase().includes('picpay')) {
                bancoValue = 'picpay';
            }

            // Mapeia o tipo de conta para o value do radio
            let tipoValue = '';
            if (accountType.toLowerCase().includes('caixinha')) {
                tipoValue = 'caixinha';
            } else if (accountType.toLowerCase().includes('corrente')) {
                tipoValue = 'corrente';
            }

            // Pr√©-seleciona o banco
            const bancoSelect = document.getElementById('editAccountBancoSelect');
            bancoSelect.value = bancoValue;

            // Reset visual dos radio buttons primeiro
            document.querySelectorAll('input[name="editTipoConta"]').forEach(r => r.checked = false);
            document.querySelectorAll('#editAccountModal .tipo-conta-option').forEach(l => {
                l.classList.remove('border-brand-500', 'bg-brand-50');
                l.classList.add('border-gray-300');
            });

            // Se tem banco selecionado, mostra o container de tipo e pr√©-seleciona
            if (bancoValue) {
                document.getElementById('editAccountTipoContainer').classList.remove('hidden');

                // Pr√©-seleciona o tipo de conta
                if (tipoValue) {
                    const tipoRadio = document.querySelector(`input[name="editTipoConta"][value="${tipoValue}"]`);
                    if (tipoRadio) {
                        tipoRadio.checked = true;
                        tipoRadio.closest('label').classList.remove('border-gray-300');
                        tipoRadio.closest('label').classList.add('border-brand-500', 'bg-brand-50');

                        // Mostra info de saldo e rendimento
                        const bancoData = editAccountBancosData[bancoValue];
                        if (bancoData) {
                            const contaInfo = bancoData[tipoValue];
                            const saldoInfo = document.getElementById('editAccountSaldoInfo');
                            const saldoText = document.getElementById('editAccountSaldoText');
                            const rendimentoInfo = document.getElementById('editAccountRendimentoInfo');
                            const hintCorrente = document.getElementById('editAccountHintCorrente');

                            // Mostra saldo
                            const nomeBanco = bancoSelect.options[bancoSelect.selectedIndex].text.replace('üè¶ ', '');
                            const tipoLabel = tipoValue === 'corrente' ? 'Conta Corrente' : 'Caixinha';
                            saldoText.textContent = `üí∞ Saldo em ${nomeBanco} (${tipoLabel}): ${formatCurrency(contaInfo.saldo)}`;
                            saldoInfo.classList.remove('hidden');

                            // Mostra info de rendimento ou config de rendimento
                            const rendimentoConfig = document.getElementById('editAccountRendimentoConfig');

                            if (contaInfo.rendimento) {
                                document.getElementById('editAccountContaNome').textContent = nomeBanco;
                                document.getElementById('editAccountContaCDI').textContent = contaInfo.rendimento.cdi + '%';
                                rendimentoInfo.classList.remove('hidden');
                                rendimentoConfig.classList.add('hidden');
                                hintCorrente.classList.add('hidden');
                            } else {
                                rendimentoInfo.classList.add('hidden');
                                rendimentoConfig.classList.remove('hidden');
                                if (tipoValue === 'corrente') {
                                    hintCorrente.classList.remove('hidden');
                                } else {
                                    hintCorrente.classList.add('hidden');
                                }
                            }
                        }
                    }
                } else {
                    document.getElementById('editAccountSaldoInfo').classList.add('hidden');
                    document.getElementById('editAccountRendimentoInfo').classList.add('hidden');
                    document.getElementById('editAccountRendimentoConfig').classList.add('hidden');
                    document.getElementById('editAccountHintCorrente').classList.add('hidden');
                }
            } else {
                document.getElementById('editAccountTipoContainer').classList.add('hidden');
                document.getElementById('editAccountSaldoInfo').classList.add('hidden');
                document.getElementById('editAccountRendimentoInfo').classList.add('hidden');
                document.getElementById('editAccountRendimentoConfig').classList.add('hidden');
                document.getElementById('editAccountHintCorrente').classList.add('hidden');
            }

            // Reset campos de rendimento manual
            document.getElementById('editAccountTemRendimento').checked = false;
            document.getElementById('editAccountCamposRendimento').classList.add('hidden');
            document.getElementById('editAccountCDIInput').value = '';

            // Mostra aviso de dep√≥sito autom√°tico se houver
            const env = envelopesData[currentEnvelope.id];
            if (env && env.autoDeposit && env.autoDeposit.enabled) {
                document.getElementById('editAccountAutoDepositWarning').classList.remove('hidden');
            } else {
                document.getElementById('editAccountAutoDepositWarning').classList.add('hidden');
            }

            document.getElementById('editAccountModal').classList.remove('hidden');
            // Mant√©m o modal-open pois a sidebar j√° o adicionou
        }

        function closeEditAccountModal() {
            document.getElementById('editAccountModal').classList.add('hidden');
        }

        // Dados de saldo e rendimento por banco (igual ao criar envelope)
        const editAccountBancosData = {
            'nubank': {
                corrente: { saldo: 3500, rendimento: null },
                caixinha: { saldo: 2800, rendimento: { cdi: 100 } }
            },
            'inter': {
                corrente: { saldo: 1200, rendimento: null },
                caixinha: { saldo: 4500, rendimento: { cdi: 100 } }
            },
            'picpay': {
                corrente: { saldo: 800, rendimento: { cdi: 102 } },
                caixinha: { saldo: 1500, rendimento: { cdi: 102 } }
            }
        };

        // Quando seleciona um banco
        document.getElementById('editAccountBancoSelect')?.addEventListener('change', function() {
            const banco = this.value;
            const tipoContainer = document.getElementById('editAccountTipoContainer');

            if (banco) {
                tipoContainer.classList.remove('hidden');
                // Reset tipo selecionado
                document.querySelectorAll('input[name="editTipoConta"]').forEach(r => r.checked = false);
                document.querySelectorAll('#editAccountModal .tipo-conta-option').forEach(l => {
                    l.classList.remove('border-brand-500', 'bg-brand-50');
                    l.classList.add('border-gray-300');
                });
                document.getElementById('editAccountSaldoInfo').classList.add('hidden');
                document.getElementById('editAccountRendimentoInfo').classList.add('hidden');
                document.getElementById('editAccountRendimentoConfig').classList.add('hidden');
                document.getElementById('editAccountHintCorrente').classList.add('hidden');
                // Reset campos de rendimento manual
                document.getElementById('editAccountTemRendimento').checked = false;
                document.getElementById('editAccountCamposRendimento').classList.add('hidden');
                document.getElementById('editAccountCDIInput').value = '';
            } else {
                tipoContainer.classList.add('hidden');
            }
        });

        // Quando seleciona tipo de conta (corrente ou caixinha)
        document.querySelectorAll('input[name="editTipoConta"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const tipo = this.value;
                const banco = document.getElementById('editAccountBancoSelect').value;
                const bancoData = editAccountBancosData[banco];

                if (!bancoData) return;

                // Atualiza visual dos radio buttons
                document.querySelectorAll('#editAccountModal .tipo-conta-option').forEach(l => {
                    l.classList.remove('border-brand-500', 'bg-brand-50');
                    l.classList.add('border-gray-300');
                });
                this.closest('label').classList.remove('border-gray-300');
                this.closest('label').classList.add('border-brand-500', 'bg-brand-50');

                const contaInfo = bancoData[tipo];
                const saldoInfo = document.getElementById('editAccountSaldoInfo');
                const saldoText = document.getElementById('editAccountSaldoText');
                const rendimentoInfo = document.getElementById('editAccountRendimentoInfo');
                const hintCorrente = document.getElementById('editAccountHintCorrente');

                // Mostra saldo
                const nomeBanco = document.getElementById('editAccountBancoSelect').options[document.getElementById('editAccountBancoSelect').selectedIndex].text.replace('üè¶ ', '');
                const tipoLabel = tipo === 'corrente' ? 'Conta Corrente' : 'Caixinha';
                saldoText.textContent = `üí∞ Saldo em ${nomeBanco} (${tipoLabel}): ${formatCurrency(contaInfo.saldo)}`;
                saldoInfo.classList.remove('hidden');

                // Mostra info de rendimento ou config de rendimento
                const rendimentoConfig = document.getElementById('editAccountRendimentoConfig');

                if (contaInfo.rendimento) {
                    document.getElementById('editAccountContaNome').textContent = nomeBanco;
                    document.getElementById('editAccountContaCDI').textContent = contaInfo.rendimento.cdi + '%';
                    rendimentoInfo.classList.remove('hidden');
                    rendimentoConfig.classList.add('hidden');
                    hintCorrente.classList.add('hidden');
                } else {
                    rendimentoInfo.classList.add('hidden');
                    rendimentoConfig.classList.remove('hidden');
                    if (tipo === 'corrente') {
                        hintCorrente.classList.remove('hidden');
                    } else {
                        hintCorrente.classList.add('hidden');
                    }
                }
            });
        });

        // Handler do checkbox de configurar rendimento
        document.getElementById('editAccountTemRendimento')?.addEventListener('change', function() {
            const camposRendimento = document.getElementById('editAccountCamposRendimento');
            if (this.checked) {
                camposRendimento.classList.remove('hidden');
            } else {
                camposRendimento.classList.add('hidden');
            }
        });

        // Handler do formul√°rio de editar conta
        document.getElementById('editAccountForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const banco = document.getElementById('editAccountBancoSelect').value;
            const tipoSelected = document.querySelector('input[name="editTipoConta"]:checked');

            if (!banco) {
                alert('Por favor, selecione uma conta.');
                return;
            }

            if (!tipoSelected) {
                alert('Por favor, selecione o tipo de conta (Corrente ou Caixinha).');
                return;
            }

            const tipo = tipoSelected.value;
            const nomeBanco = document.getElementById('editAccountBancoSelect').options[document.getElementById('editAccountBancoSelect').selectedIndex].text.replace('üè¶ ', '');
            const tipoLabel = tipo === 'corrente' ? 'Conta Corrente' : 'Caixinha';
            const newAccountName = `${nomeBanco} (${tipoLabel})`;
            const bancoData = editAccountBancosData[banco];
            const contaInfo = bancoData[tipo];

            // Atualiza o envelope (simula√ß√£o)
            currentEnvelope.account = newAccountName;
            currentEnvelope.accountType = tipoLabel;

            if (envelopesData[currentEnvelope.id]) {
                envelopesData[currentEnvelope.id].account = newAccountName;
                envelopesData[currentEnvelope.id].accountType = tipoLabel;

                // Atualiza rendimento se a conta tiver ou se foi configurado manualmente
                if (contaInfo.rendimento) {
                    envelopesData[currentEnvelope.id].rendimento = {
                        enabled: true,
                        cdi: contaInfo.rendimento.cdi,
                        total: envelopesData[currentEnvelope.id].rendimento?.total || 0
                    };
                } else {
                    // Verifica se foi configurado rendimento manualmente
                    const temRendimento = document.getElementById('editAccountTemRendimento')?.checked;
                    const cdiManual = parseFloat(document.getElementById('editAccountCDIInput')?.value);

                    if (temRendimento && cdiManual > 0) {
                        envelopesData[currentEnvelope.id].rendimento = {
                            enabled: true,
                            cdi: cdiManual,
                            total: envelopesData[currentEnvelope.id].rendimento?.total || 0
                        };
                    } else {
                        envelopesData[currentEnvelope.id].rendimento = { enabled: false };
                    }
                }
            }

            alert(`Conta vinculada alterada para ${newAccountName}.\nO saldo de ${formatCurrency(currentEnvelope.balance)} ser√° transferido automaticamente.`);
            closeEditAccountModal();

            // Re-renderiza a sidebar para mostrar a nova conta
            openEnvelopeDetails(currentEnvelope.id);
        });

        // Editar Dep√≥sito Autom√°tico - substitui conte√∫do da sidebar de detalhes
        function openEditAutoDepositModal() {
            const env = envelopesData[currentEnvelope.id];
            if (!env) return;

            const autoDeposit = env.autoDeposit;
            const tipoValue = autoDeposit.type || 'frequencia';

            // Gera o HTML do header
            const headerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button onclick="backToEnvelopeDetails()" class="text-gray-400 hover:text-gray-600 p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Editar Dep√≥sito Autom√°tico</h2>
                            <p class="text-sm text-gray-500">${env.name}</p>
                        </div>
                    </div>
                    <button onclick="closeEnvelopeDetails()" class="text-gray-400 hover:text-gray-600 p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;

            // Gera o HTML do conte√∫do
            const contentHTML = `
                <form id="editAutoDepositForm" class="space-y-4">
                    <!-- Tipo de Dep√≥sito -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quando depositar?</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label id="editAutoDepositTipoFrequencia" class="tipo-deposito-option border-2 ${tipoValue === 'frequencia' ? 'border-brand-500 bg-brand-50' : 'border-gray-300'} rounded-lg p-3 cursor-pointer hover:border-brand-500 transition">
                                <input type="radio" name="editAutoDepositTipo" value="frequencia" class="mr-2" ${tipoValue === 'frequencia' ? 'checked' : ''}>
                                <span class="text-sm font-medium">Por frequ√™ncia</span>
                                <p class="text-xs text-gray-500 ml-6">Ex: todo dia 5</p>
                            </label>
                            <label id="editAutoDepositTipoReceita" class="tipo-deposito-option border-2 ${tipoValue === 'receita' ? 'border-brand-500 bg-brand-50' : 'border-gray-300'} rounded-lg p-3 cursor-pointer hover:border-brand-500 transition">
                                <input type="radio" name="editAutoDepositTipo" value="receita" class="mr-2" ${tipoValue === 'receita' ? 'checked' : ''}>
                                <span class="text-sm font-medium">Quando receber</span>
                                <p class="text-xs text-gray-500 ml-6">Ao receber receitas</p>
                            </label>
                        </div>
                    </div>

                    <!-- Campos Frequ√™ncia -->
                    <div id="editAutoDepositCamposFrequencia" class="${tipoValue === 'frequencia' ? '' : 'hidden'} space-y-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-2">Valor do dep√≥sito</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3 text-gray-500">R$</span>
                                <input type="number" step="0.01" id="editAutoDepositValorFixo" value="${tipoValue === 'frequencia' ? (autoDeposit.value || '') : ''}" placeholder="200,00" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-brand-500">
                            </div>
                        </div>

                        <div class="p-4 bg-gray-50 rounded-xl space-y-4">
                            <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Repetir</p>

                            <div>
                                <select id="editAutoDepositFrequencia" class="w-full px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent bg-white font-medium">
                                    <option value="diaria" ${autoDeposit.frequency === 'diaria' || autoDeposit.frequency === 'Di√°ria' ? 'selected' : ''}>Todo dia</option>
                                    <option value="semanal" ${autoDeposit.frequency === 'semanal' || autoDeposit.frequency === 'Semanal' ? 'selected' : ''}>Toda semana</option>
                                    <option value="quinzenal" ${autoDeposit.frequency === 'quinzenal' || autoDeposit.frequency === 'Quinzenal' ? 'selected' : ''}>A cada 15 dias</option>
                                    <option value="mensal" ${!autoDeposit.frequency || autoDeposit.frequency === 'mensal' || autoDeposit.frequency === 'Mensal' ? 'selected' : ''}>Todo m√™s</option>
                                    <option value="trimestral" ${autoDeposit.frequency === 'trimestral' ? 'selected' : ''}>A cada 3 meses</option>
                                    <option value="anual" ${autoDeposit.frequency === 'anual' ? 'selected' : ''}>Todo ano</option>
                                </select>
                            </div>

                            <div id="editAutoDeposit-opcoes-mensal" class="space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1.5">Quando</label>
                                    <select id="editAutoDeposit-quando-mensal" class="w-full px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent bg-white">
                                        <option value="dia" selected>Dia espec√≠fico</option>
                                        <option value="primeiro">Primeiro dia do m√™s</option>
                                        <option value="ultimo">√öltimo dia do m√™s</option>
                                        <option value="primeiro-util">Primeiro dia √∫til</option>
                                        <option value="ultimo-util">√öltimo dia √∫til</option>
                                    </select>
                                </div>

                                <div id="editAutoDeposit-dia-especifico-container" class="flex items-center gap-3">
                                    <div class="flex-1">
                                        <label class="block text-xs text-gray-500 mb-1.5">Dia</label>
                                        <input type="number" id="editAutoDepositDia" min="1" max="28" value="${autoDeposit.day || 5}" class="w-full px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent bg-white font-medium">
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-xs text-gray-500 mb-1.5">&nbsp;</label>
                                        <label class="flex items-center h-[46px] px-4 bg-white border border-gray-300 rounded-xl cursor-pointer hover:bg-gray-50">
                                            <input type="checkbox" id="editAutoDeposit-dia-util-check" class="mr-2 text-brand-600 focus:ring-brand-500 rounded" ${autoDeposit.diaUtil ? 'checked' : ''}>
                                            <span class="text-sm text-gray-700">Dia √∫til</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div id="editAutoDeposit-opcoes-semanal" class="hidden">
                                <label class="block text-xs text-gray-500 mb-1.5">No dia</label>
                                <select id="editAutoDeposit-dia-semana" class="w-full px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent bg-white">
                                    <option value="domingo">Domingo</option>
                                    <option value="segunda" selected>Segunda-feira</option>
                                    <option value="terca">Ter√ßa-feira</option>
                                    <option value="quarta">Quarta-feira</option>
                                    <option value="quinta">Quinta-feira</option>
                                    <option value="sexta">Sexta-feira</option>
                                    <option value="sabado">S√°bado</option>
                                </select>
                            </div>

                            <div id="editAutoDeposit-opcoes-diaria" class="hidden">
                                <label class="flex items-center p-3 bg-white rounded-xl border border-gray-200 cursor-pointer hover:bg-gray-50">
                                    <input type="checkbox" id="editAutoDeposit-apenas-dias-uteis" class="mr-3 text-brand-600 focus:ring-brand-500 rounded" ${autoDeposit.apenasDiasUteis ? 'checked' : ''}>
                                    <div>
                                        <span class="text-sm font-medium text-gray-700">Apenas dias √∫teis</span>
                                        <p class="text-xs text-gray-500">Ignora s√°bados, domingos e feriados</p>
                                    </div>
                                </label>
                            </div>

                            <div class="flex items-center justify-between p-3 bg-brand-50 rounded-xl border border-brand-100">
                                <div class="flex items-center text-sm">
                                    <svg class="w-5 h-5 text-brand-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="text-brand-700">Pr√≥ximo dep√≥sito</span>
                                </div>
                                <span id="editAutoDepositPreviewInline" class="text-sm font-semibold text-brand-800">${autoDeposit.nextDate || '05/Fev/2026'}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Campos Quando Receber -->
                    <div id="editAutoDepositCamposReceita" class="${tipoValue === 'receita' ? '' : 'hidden'} space-y-4">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm text-gray-600">Quanto depositar?</label>
                                <div class="inline-flex rounded-lg border border-gray-300 p-1 bg-gray-50">
                                    <button type="button" id="editAutoDepositToggleFixo" class="edit-auto-toggle px-3 py-1 text-xs font-medium rounded transition ${!autoDeposit.isPercent ? 'bg-white shadow-sm text-brand-600' : 'text-gray-600'}">
                                        R$ Fixo
                                    </button>
                                    <button type="button" id="editAutoDepositTogglePercent" class="edit-auto-toggle px-3 py-1 text-xs font-medium rounded transition ${autoDeposit.isPercent ? 'bg-white shadow-sm text-brand-600' : 'text-gray-600'}">
                                        % Percentual
                                    </button>
                                </div>
                            </div>

                            <div id="editAutoDepositValorFixoReceita" class="${autoDeposit.isPercent ? 'hidden' : ''}">
                                <div class="relative">
                                    <span class="absolute left-4 top-3 text-gray-500">R$</span>
                                    <input type="number" step="0.01" id="editAutoDepositValorFixoInput" value="${tipoValue === 'receita' && !autoDeposit.isPercent ? (autoDeposit.value || '') : ''}" placeholder="200,00" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500">
                                </div>
                            </div>

                            <div id="editAutoDepositValorPercentual" class="${!autoDeposit.isPercent ? 'hidden' : ''}">
                                <div class="relative">
                                    <input type="number" step="0.01" id="editAutoDepositPercentInput" value="${tipoValue === 'receita' && autoDeposit.isPercent ? (autoDeposit.value || '') : ''}" placeholder="10" class="w-full pr-10 pl-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500">
                                    <span class="absolute right-4 top-3 text-gray-500">%</span>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 mb-2">Aplicar em</label>
                            <select id="editAutoDepositAplicarEm" class="aplicar-em-select w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500" data-target="editSeletorCategorias">
                                <option value="todas" ${!autoDeposit.appliesTo || autoDeposit.appliesTo === 'Todas receitas' || autoDeposit.appliesTo === 'todas' ? 'selected' : ''}>Todas as receitas</option>
                                <option value="categorias" ${autoDeposit.appliesTo && autoDeposit.appliesTo !== 'Todas receitas' && autoDeposit.appliesTo !== 'todas' ? 'selected' : ''}>Categorias espec√≠ficas</option>
                            </select>

                            <div id="editSeletorCategorias" class="${!autoDeposit.appliesTo || autoDeposit.appliesTo === 'Todas receitas' || autoDeposit.appliesTo === 'todas' ? 'hidden' : ''} mt-3">
                                <label class="block text-xs text-gray-600 mb-2">Selecione as categorias de receita:</label>
                                <div class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                        <input type="checkbox" name="editCategoriasReceita" value="salario" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                        <span class="text-sm">üíº Sal√°rio</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                        <input type="checkbox" name="editCategoriasReceita" value="freelance" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                        <span class="text-sm">üíª Freelance</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                        <input type="checkbox" name="editCategoriasReceita" value="investimentos" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                        <span class="text-sm">üìà Investimentos</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                        <input type="checkbox" name="editCategoriasReceita" value="vendas" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                        <span class="text-sm">üí∞ Vendas</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                        <input type="checkbox" name="editCategoriasReceita" value="presente" class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500">
                                        <span class="text-sm">üéÅ Presente</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Continuar ap√≥s valor alvo -->
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox" id="editAutoDepositContinueAfterGoal" class="mt-0.5 w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500" ${autoDeposit.continueAfterGoal ? 'checked' : ''}>
                            <div class="ml-3">
                                <span class="text-sm font-medium text-gray-700">Continuar mesmo ap√≥s atingir o valor alvo</span>
                                <p class="text-xs text-gray-500 mt-1">Se marcado, o dep√≥sito autom√°tico continuar√° sendo realizado mesmo depois que o valor alvo for alcan√ßado.</p>
                            </div>
                        </label>
                    </div>

                    <!-- Bot√µes -->
                    <div class="flex space-x-3 pt-4">
                        <button type="button" onclick="backToEnvelopeDetails()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition">
                            Cancelar
                        </button>
                        <button type="submit" class="flex-1 bg-brand-500 hover:bg-brand-600 text-white py-3 rounded-lg font-medium transition flex items-center justify-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span>Salvar</span>
                        </button>
                    </div>
                </form>
            `;

            // Substitui o conte√∫do da sidebar
            document.getElementById('sidebarHeader').innerHTML = headerHTML;
            document.getElementById('sidebarContent').innerHTML = contentHTML;

            // Adiciona event listeners din√¢micos
            setupEditAutoDepositListeners();
        }

        // Volta para os detalhes do envelope
        function backToEnvelopeDetails() {
            openEnvelopeDetails(currentEnvelope.id);
        }

        // Configura os event listeners do formul√°rio de edi√ß√£o de dep√≥sito autom√°tico
        function setupEditAutoDepositListeners() {
            // Handler para tipo de dep√≥sito (frequ√™ncia vs receita)
            document.querySelectorAll('input[name="editAutoDepositTipo"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const tipo = this.value;

                    // Atualiza visual dos radio buttons
                    document.querySelectorAll('.tipo-deposito-option').forEach(l => {
                        l.classList.remove('border-brand-500', 'bg-brand-50');
                        l.classList.add('border-gray-300');
                    });
                    this.closest('label').classList.remove('border-gray-300');
                    this.closest('label').classList.add('border-brand-500', 'bg-brand-50');

                    // Mostra/esconde campos
                    const camposFrequencia = document.getElementById('editAutoDepositCamposFrequencia');
                    const camposReceita = document.getElementById('editAutoDepositCamposReceita');

                    if (tipo === 'frequencia') {
                        camposFrequencia.classList.remove('hidden');
                        camposReceita.classList.add('hidden');
                    } else {
                        camposFrequencia.classList.add('hidden');
                        camposReceita.classList.remove('hidden');
                    }
                });
            });

            // Handler para frequ√™ncia
            document.getElementById('editAutoDepositFrequencia')?.addEventListener('change', updateEditAutoDepositFrequenciaOptions);

            // Handler para "quando" mensal
            document.getElementById('editAutoDeposit-quando-mensal')?.addEventListener('change', toggleEditAutoDepositDiaEspecifico);

            // Toggle fixo/percentual
            document.getElementById('editAutoDepositToggleFixo')?.addEventListener('click', function() {
                this.classList.add('bg-white', 'shadow-sm', 'text-brand-600');
                this.classList.remove('text-gray-600');
                document.getElementById('editAutoDepositTogglePercent').classList.remove('bg-white', 'shadow-sm', 'text-brand-600');
                document.getElementById('editAutoDepositTogglePercent').classList.add('text-gray-600');
                document.getElementById('editAutoDepositValorFixoReceita').classList.remove('hidden');
                document.getElementById('editAutoDepositValorPercentual').classList.add('hidden');
            });

            document.getElementById('editAutoDepositTogglePercent')?.addEventListener('click', function() {
                this.classList.add('bg-white', 'shadow-sm', 'text-brand-600');
                this.classList.remove('text-gray-600');
                document.getElementById('editAutoDepositToggleFixo').classList.remove('bg-white', 'shadow-sm', 'text-brand-600');
                document.getElementById('editAutoDepositToggleFixo').classList.add('text-gray-600');
                document.getElementById('editAutoDepositValorFixoReceita').classList.add('hidden');
                document.getElementById('editAutoDepositValorPercentual').classList.remove('hidden');
            });

            // Handler para "aplicar em"
            document.getElementById('editAutoDepositAplicarEm')?.addEventListener('change', function() {
                const seletorCategorias = document.getElementById('editSeletorCategorias');
                if (this.value === 'categorias') {
                    seletorCategorias.classList.remove('hidden');
                } else {
                    seletorCategorias.classList.add('hidden');
                }
            });

            // Handler do formul√°rio
            document.getElementById('editAutoDepositForm')?.addEventListener('submit', handleEditAutoDepositSubmit);

            // Atualiza op√ß√µes de frequ√™ncia iniciais
            updateEditAutoDepositFrequenciaOptions();
        }

        // Handler do submit do formul√°rio de edi√ß√£o de dep√≥sito autom√°tico
        function handleEditAutoDepositSubmit(e) {
            e.preventDefault();

            const tipoSelected = document.querySelector('input[name="editAutoDepositTipo"]:checked');
            const tipo = tipoSelected ? tipoSelected.value : 'frequencia';

            let valor, frequency, quando, day, diaUtil, diaSemana, apenasDiasUteis, isPercent, appliesTo;

            if (tipo === 'frequencia') {
                valor = parseFloat(document.getElementById('editAutoDepositValorFixo').value);
                frequency = document.getElementById('editAutoDepositFrequencia').value;
                quando = document.getElementById('editAutoDeposit-quando-mensal')?.value;
                day = parseInt(document.getElementById('editAutoDepositDia').value) || 5;
                diaUtil = document.getElementById('editAutoDeposit-dia-util-check')?.checked;
                diaSemana = document.getElementById('editAutoDeposit-dia-semana')?.value;
                apenasDiasUteis = document.getElementById('editAutoDeposit-apenas-dias-uteis')?.checked;
            } else {
                const isPercentSelected = document.getElementById('editAutoDepositTogglePercent').classList.contains('text-brand-600');
                if (isPercentSelected) {
                    valor = parseFloat(document.getElementById('editAutoDepositPercentInput').value);
                    isPercent = true;
                } else {
                    valor = parseFloat(document.getElementById('editAutoDepositValorFixoInput').value);
                    isPercent = false;
                }

                const aplicarEmValue = document.getElementById('editAutoDepositAplicarEm').value;
                if (aplicarEmValue === 'todas') {
                    appliesTo = 'Todas receitas';
                } else {
                    const categoriasChecked = document.querySelectorAll('input[name="editCategoriasReceita"]:checked');
                    const categoriasNames = {
                        'salario': 'Sal√°rio',
                        'freelance': 'Freelance',
                        'investimentos': 'Investimentos',
                        'vendas': 'Vendas',
                        'presente': 'Presente'
                    };
                    appliesTo = Array.from(categoriasChecked).map(cb => categoriasNames[cb.value] || cb.value).join(', ') || 'Todas receitas';
                }
            }

            const continueAfterGoal = document.getElementById('editAutoDepositContinueAfterGoal')?.checked || false;

            const tipoLabel = tipo === 'frequencia' ? 'Por frequ√™ncia' : 'Quando receber';

            // Atualiza dados mockados
            if (envelopesData[currentEnvelope.id]) {
                envelopesData[currentEnvelope.id].autoDeposit = {
                    enabled: true,
                    type: tipo,
                    value: valor,
                    isPercent: isPercent || false,
                    frequency: frequency,
                    quando: quando,
                    day: day,
                    diaUtil: diaUtil,
                    diaSemana: diaSemana,
                    apenasDiasUteis: apenasDiasUteis,
                    appliesTo: appliesTo,
                    continueAfterGoal: continueAfterGoal,
                    nextDate: '05/Fev/2026'
                };
            }

            alert(`Dep√≥sito autom√°tico atualizado!\nTipo: ${tipoLabel}\nValor: ${isPercent ? valor + '%' : formatCurrency(valor)}`);

            // Volta para os detalhes do envelope
            backToEnvelopeDetails();
        }

        // Atualiza op√ß√µes de frequ√™ncia baseado na sele√ß√£o
        function updateEditAutoDepositFrequenciaOptions() {
            const frequencia = document.getElementById('editAutoDepositFrequencia')?.value;
            const opcoesMensal = document.getElementById('editAutoDeposit-opcoes-mensal');
            const opcoesSemanal = document.getElementById('editAutoDeposit-opcoes-semanal');
            const opcoesDiaria = document.getElementById('editAutoDeposit-opcoes-diaria');

            // Esconde todos
            opcoesMensal?.classList.add('hidden');
            opcoesSemanal?.classList.add('hidden');
            opcoesDiaria?.classList.add('hidden');

            // Mostra baseado na frequ√™ncia
            if (frequencia === 'mensal' || frequencia === 'trimestral' || frequencia === 'anual') {
                opcoesMensal?.classList.remove('hidden');
            } else if (frequencia === 'semanal' || frequencia === 'quinzenal') {
                opcoesSemanal?.classList.remove('hidden');
            } else if (frequencia === 'diaria') {
                opcoesDiaria?.classList.remove('hidden');
            }
        }

        // Toggle dia espec√≠fico baseado em "quando"
        function toggleEditAutoDepositDiaEspecifico() {
            const quando = document.getElementById('editAutoDeposit-quando-mensal')?.value;
            const container = document.getElementById('editAutoDeposit-dia-especifico-container');

            if (quando === 'dia') {
                container?.classList.remove('hidden');
            } else {
                container?.classList.add('hidden');
            }
        }

        // === Handlers gen√©ricos para formul√°rios de cria√ß√£o (META e FUNDO) ===

        // Fun√ß√£o gen√©rica para atualizar op√ß√µes de frequ√™ncia
        function updateFrequenciaOptions(prefix) {
            const frequencia = document.getElementById(`${prefix}Frequencia`)?.value;
            const opcoesMensal = document.getElementById(`${prefix}-opcoes-mensal`);
            const opcoesSemanal = document.getElementById(`${prefix}-opcoes-semanal`);
            const opcoesDiaria = document.getElementById(`${prefix}-opcoes-diaria`);

            // Esconde todos
            opcoesMensal?.classList.add('hidden');
            opcoesSemanal?.classList.add('hidden');
            opcoesDiaria?.classList.add('hidden');

            // Mostra baseado na frequ√™ncia
            if (frequencia === 'mensal' || frequencia === 'trimestral' || frequencia === 'anual') {
                opcoesMensal?.classList.remove('hidden');
            } else if (frequencia === 'semanal' || frequencia === 'quinzenal') {
                opcoesSemanal?.classList.remove('hidden');
            } else if (frequencia === 'diaria') {
                opcoesDiaria?.classList.remove('hidden');
            }
        }

        // Fun√ß√£o gen√©rica para toggle dia espec√≠fico
        function toggleDiaEspecifico(prefix) {
            const quando = document.getElementById(`${prefix}-quando-mensal`)?.value;
            const container = document.getElementById(`${prefix}-dia-especifico-container`);

            if (quando === 'dia') {
                container?.classList.remove('hidden');
            } else {
                container?.classList.add('hidden');
            }
        }

        // Handlers para formul√°rio de cria√ß√£o META
        document.getElementById('createMetaFrequencia')?.addEventListener('change', function() {
            updateFrequenciaOptions('createMeta');
        });
        document.getElementById('createMeta-quando-mensal')?.addEventListener('change', function() {
            toggleDiaEspecifico('createMeta');
        });

        // Handlers para formul√°rio de cria√ß√£o FUNDO
        document.getElementById('createFundoFrequencia')?.addEventListener('change', function() {
            updateFrequenciaOptions('createFundo');
        });
        document.getElementById('createFundo-quando-mensal')?.addEventListener('change', function() {
            toggleDiaEspecifico('createFundo');
        });

        function setWithdrawValue(percentage) {
            const value = (currentEnvelope.balance * percentage) / 100;
            document.getElementById('withdrawValue').value = value.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        }

        // Handlers dos formul√°rios
        document.getElementById('depositForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const value = document.getElementById('depositValue').value;
            alert(`Dep√≥sito de R$ ${value} realizado com sucesso no envelope "${currentEnvelope.name}"!`);
            closeDepositModal();
        });

        document.getElementById('withdrawForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const value = document.getElementById('withdrawValue').value;
            alert(`Retirada de R$ ${value} realizada com sucesso do envelope "${currentEnvelope.name}"!`);
            closeWithdrawModal();
        });

        document.getElementById('editProductForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('editProductName').value;
            const url = document.getElementById('editProductUrl').value;
            const alertPreco = document.getElementById('editAlertPreco').checked;
            alert(`Produto "${name}" atualizado com sucesso!`);
            closeEditProductModal();
        });

        function openSettingsModal() {
            alert('Modal de configura√ß√µes em desenvolvimento');
        }

        // Modal Controls
        // === Sidebar de Cria√ß√£o de Envelope ===
        function openCreateModal() {
            const sidebar = document.getElementById('createEnvelopeSidebar');
            sidebar.classList.remove('hidden');
            document.body.classList.add('modal-open');
            // Reset para o passo 1 (escolha de tipo)
            goBackToTypeSelection();
        }

        function closeCreateEnvelopeSidebar() {
            document.getElementById('createEnvelopeSidebar').classList.add('hidden');
            document.body.classList.remove('modal-open');
            // Reset para o passo 1
            goBackToTypeSelection();
        }

        function selectEnvelopeType(type) {
            // Esconde passo 1
            document.getElementById('createEnvelopeStep1').classList.add('hidden');
            // Mostra bot√£o de voltar
            document.getElementById('createEnvelopeBackBtn').classList.remove('hidden');

            if (type === 'META') {
                document.getElementById('createEnvelopeTitle').textContent = 'üéØ Nova Meta de Economia';
                document.getElementById('createEnvelopeFormMeta').classList.remove('hidden');
                document.getElementById('createEnvelopeFormFundo').classList.add('hidden');
            } else {
                document.getElementById('createEnvelopeTitle').textContent = 'üí∞ Novo Fundo de Reserva';
                document.getElementById('createEnvelopeFormFundo').classList.remove('hidden');
                document.getElementById('createEnvelopeFormMeta').classList.add('hidden');
            }
        }

        function goBackToTypeSelection() {
            // Reset t√≠tulo
            document.getElementById('createEnvelopeTitle').textContent = 'üíº Criar Envelope';
            // Esconde bot√£o de voltar
            document.getElementById('createEnvelopeBackBtn').classList.add('hidden');
            // Mostra passo 1 e esconde formul√°rios
            document.getElementById('createEnvelopeStep1').classList.remove('hidden');
            document.getElementById('createEnvelopeFormMeta').classList.add('hidden');
            document.getElementById('createEnvelopeFormFundo').classList.add('hidden');
        }

        // Fun√ß√µes legadas (mantidas para compatibilidade)
        function closeChooseTypeModal() {
            closeCreateEnvelopeSidebar();
        }

        function openCreateFormModal(type) {
            selectEnvelopeType(type);
        }

        function closeCreateFormModal() {
            closeCreateEnvelopeSidebar();
        }

        // Toggle Dep√≥sito Autom√°tico - META (nova sidebar)
        document.getElementById('depositoAutoMeta')?.addEventListener('change', function() {
            const fields = document.getElementById('depositoAutoFieldsMeta');
            if (this.checked) {
                fields.classList.remove('hidden');
            } else {
                fields.classList.add('hidden');
            }
        });

        // Toggle Dep√≥sito Autom√°tico - FUNDO (nova sidebar)
        document.getElementById('depositoAutoFundo')?.addEventListener('change', function() {
            const fields = document.getElementById('depositoAutoFieldsFundo');
            if (this.checked) {
                fields.classList.remove('hidden');
            } else {
                fields.classList.add('hidden');
            }
        });

        // Toggle entre Frequ√™ncia e Quando Receber - META (nova sidebar)
        document.querySelectorAll('input[name="tipoDepositoMeta"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const camposFreq = document.getElementById('camposFrequenciaMeta');
                const camposRec = document.getElementById('camposReceitaMeta');

                if (this.value === 'frequencia') {
                    camposFreq.classList.remove('hidden');
                    camposRec.classList.add('hidden');
                } else {
                    camposFreq.classList.add('hidden');
                    camposRec.classList.remove('hidden');
                }
            });
        });

        // Toggle entre Frequ√™ncia e Quando Receber - FUNDO (nova sidebar)
        document.querySelectorAll('input[name="tipoDepositoFundo"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const camposFreq = document.getElementById('camposFrequenciaFundo');
                const camposRec = document.getElementById('camposReceitaFundo');

                if (this.value === 'frequencia') {
                    camposFreq.classList.remove('hidden');
                    camposRec.classList.add('hidden');
                } else {
                    camposFreq.classList.add('hidden');
                    camposRec.classList.remove('hidden');
                }
            });
        });

        // Icon Selection
        document.querySelectorAll('.icon-option').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();

                // Remove selected from siblings in the same form
                const form = this.closest('form');
                form.querySelectorAll('.icon-option').forEach(b => {
                    b.classList.remove('selected');
                });

                // Add selected to clicked button
                this.classList.add('selected');
            });
        });

        // Toggle Valor Fixo/Percentual (Quando Receber)
        document.querySelectorAll('.toggle-valor-tipo').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();

                const tipo = this.dataset.tipo;
                const target = this.dataset.target;
                const container = this.closest('.inline-flex');

                // Update toggle button styles
                container.querySelectorAll('.toggle-valor-tipo').forEach(b => {
                    b.classList.remove('bg-white', 'shadow-sm', 'text-brand-600');
                    b.classList.add('text-gray-600');
                });
                this.classList.add('bg-white', 'shadow-sm', 'text-brand-600');
                this.classList.remove('text-gray-600');

                // Toggle input fields
                const fixoField = document.getElementById(`valorFixo${target.charAt(0).toUpperCase() + target.slice(1)}`);
                const percentualField = document.getElementById(`valorPercentual${target.charAt(0).toUpperCase() + target.slice(1)}`);

                if (tipo === 'fixo') {
                    fixoField.classList.remove('hidden');
                    percentualField.classList.add('hidden');
                } else {
                    fixoField.classList.add('hidden');
                    percentualField.classList.remove('hidden');
                }
            });
        });

        // Toggle Seletor de Categorias (Aplicar Em)
        document.querySelectorAll('.aplicar-em-select').forEach(select => {
            select.addEventListener('change', function() {
                const targetId = this.dataset.target;
                const seletor = document.getElementById(targetId);

                if (this.value === 'categorias') {
                    seletor.classList.remove('hidden');
                } else {
                    seletor.classList.add('hidden');
                }
            });
        });

        // PASSO 1: Selecionar Banco
        document.querySelectorAll('.conta-banco-select').forEach(select => {
            select.addEventListener('change', function() {
                const container = this.closest('div').parentElement;
                const tipoContaContainer = container.querySelector('.tipo-conta-container');
                const saldoInfo = container.querySelector('.saldo-info');
                const rendimentoInfo = container.querySelector('.conta-tem-rendimento-info');

                if (this.value) {
                    // Mostra o segundo passo
                    tipoContaContainer.classList.remove('hidden');

                    // Atualiza saldo info baseado no banco
                    const saldos = {
                        'nubank': 'R$ 5.230,00',
                        'inter': 'R$ 1.850,00',
                        'picpay': 'R$ 320,00'
                    };

                    // Configura√ß√£o de rendimento por banco
                    const rendimentos = {
                        'nubank': { tem: true, cdi: 100 },
                        'inter': { tem: true, cdi: 100 },
                        'picpay': { tem: false, cdi: 0 }
                    };

                    if (saldoInfo) {
                        saldoInfo.querySelector('.saldo-valor').textContent = saldos[this.value] || 'R$ 0,00';
                    }

                    // Mostrar info de rendimento se a conta tiver
                    if (rendimentos[this.value] && rendimentos[this.value].tem) {
                        if (rendimentoInfo) {
                            rendimentoInfo.classList.remove('hidden');
                            const nomeConta = this.options[this.selectedIndex].text.replace('üè¶ ', '');
                            rendimentoInfo.querySelector('.conta-nome-display').textContent = nomeConta;
                            rendimentoInfo.querySelector('.conta-cdi-display').textContent = rendimentos[this.value].cdi + '%';
                        }
                    } else {
                        if (rendimentoInfo) {
                            rendimentoInfo.classList.add('hidden');
                        }
                    }
                } else {
                    // Esconde tudo se desselecionar
                    tipoContaContainer.classList.add('hidden');
                    if (rendimentoInfo) {
                        rendimentoInfo.classList.add('hidden');
                    }
                }
            });
        });

        // PASSO 2: Selecionar Tipo de Conta (Corrente ou Caixinha)
        document.querySelectorAll('input[name="tipoConta"], input[name="tipoContaFundo"], input[name="tipoContaMeta"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const container = this.closest('.tipo-conta-container');
                const rendimentoConfig = container.querySelector('.rendimento-config');
                const hintCorrente = container.querySelector('.hint-corrente');
                const rendimentoExplicacao = container.querySelector('.rendimento-explicacao');
                const saldoInfo = container.querySelector('.saldo-info');

                // Mostra configura√ß√£o de rendimento
                rendimentoConfig.classList.remove('hidden');

                if (this.value === 'corrente') {
                    // Conta Corrente: mostra hint e texto sobre rendimento proporcional
                    hintCorrente?.classList.remove('hidden');
                    if (rendimentoExplicacao) {
                        rendimentoExplicacao.textContent = 'O rendimento ser√° calculado proporcionalmente ao valor no envelope e adicionado automaticamente.';
                    }
                    if (saldoInfo) {
                        saldoInfo.querySelector('.saldo-tipo').textContent = 'Conta Corrente';
                    }
                } else {
                    // Caixinha: esconde hint e mostra texto sobre rendimento total
                    hintCorrente?.classList.add('hidden');
                    if (rendimentoExplicacao) {
                        rendimentoExplicacao.textContent = 'Todo o rendimento desta caixinha ser√° adicionado ao envelope automaticamente.';
                    }
                    if (saldoInfo) {
                        saldoInfo.querySelector('.saldo-tipo').textContent = 'Caixinha';
                    }
                }

                // Mostra saldo info
                saldoInfo?.classList.remove('hidden');
            });
        });

        // Toggle campos de rendimento quando checkbox √© marcado
        document.querySelectorAll('.tem-rendimento').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const container = this.closest('.rendimento-config');
                const tipoContaContainer = container.closest('.tipo-conta-container');
                const campos = container.querySelector('.campos-rendimento');
                const hint = tipoContaContainer.querySelector('.hint-corrente');

                if (this.checked) {
                    campos.classList.remove('hidden');
                    hint?.classList.add('hidden'); // Esconde hint se marcou que tem rendimento
                } else {
                    campos.classList.add('hidden');

                    // S√≥ mostra hint se for conta corrente
                    const tipoContaInput = tipoContaContainer.querySelector('input[name^="tipoConta"]:checked');
                    if (tipoContaInput && tipoContaInput.value === 'corrente') {
                        hint?.classList.remove('hidden');
                    }
                }
            });
        });

        // Mobile Menu Toggle
        document.getElementById('mobile-menu-btn')?.addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });

        // Verificar se deve abrir o modal de cria√ß√£o automaticamente
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            console.log('URL params:', window.location.search);
            console.log('Criar param:', urlParams.get('criar'));

            if (urlParams.get('criar') === 'true') {
                console.log('Abrindo modal automaticamente...');
                // Esperar o DOM carregar se necess√°rio
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        openCreateModal();
                    });
                } else {
                    openCreateModal();
                }
                // Limpar o par√¢metro da URL para evitar que o modal abra novamente ao recarregar
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        })();

        // Verificar se deve destacar/abrir um envelope espec√≠fico
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const envelopeId = urlParams.get('id');
            const envelopeToOpen = urlParams.get('open'); // Novo par√¢metro para abrir modal diretamente

            // Se veio do dashboard com ?open=, abrir o modal diretamente
            if (envelopeToOpen) {
                console.log('Abrindo modal do envelope:', envelopeToOpen);

                const openModal = function() {
                    // Abrir o modal de detalhes
                    setTimeout(() => {
                        openEnvelopeDetails(envelopeToOpen);
                    }, 300);

                    // Limpar o par√¢metro da URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                };

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', openModal);
                } else {
                    openModal();
                }
            }
            // Sen√£o, se vier com ?id=, destacar o envelope
            else if (envelopeId) {
                console.log('Destacando envelope:', envelopeId);

                // Esperar o DOM carregar se necess√°rio
                const highlightEnvelope = function() {
                    // Tentar encontrar o card do envelope pelo ID
                    const envelopeCard = document.querySelector(`[data-envelope-id="${envelopeId}"]`);

                    if (envelopeCard) {
                        // Scroll suave at√© o envelope
                        setTimeout(() => {
                            envelopeCard.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });

                            // Adicionar destaque tempor√°rio
                            envelopeCard.classList.add('ring-4', 'ring-brand-500', 'ring-offset-2');

                            // Remover destaque ap√≥s 3 segundos
                            setTimeout(() => {
                                envelopeCard.classList.remove('ring-4', 'ring-brand-500', 'ring-offset-2');
                            }, 3000);

                            // Opcional: abrir o modal de detalhes do envelope
                            // openEnvelopeDetails(envelopeId);
                        }, 300);
                    }

                    // Limpar o par√¢metro da URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                };

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', highlightEnvelope);
                } else {
                    highlightEnvelope();
                }
            }
        })();
    </script>
</body>
</html>
